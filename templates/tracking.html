{% extends "base.html" %}

{% block title %}Tracking - Svl App{% endblock %}

{% block content %}
<div class="container mx-auto py-6">
    <!-- Page Header -->
    <div class="mb-6">
        <h1 class="text-3xl font-bold text-base-content mb-2">Tracking</h1>
        <p class="text-base-content/70">Track events and activities over time</p>
    </div>

    <!-- Timeline Section -->
    <div class="card bg-base-100 shadow-sm border border-base-300">
        <div class="card-body">
            <h2 class="card-title text-lg font-semibold mb-4">Timeline</h2>
            
            <!-- Search/Filter Input -->
            <div class="mb-6">
                <div class="form-control w-full max-w-md">
                    <label class="label">
                        <span class="label-text">Search by Detection ID</span>
                    </label>
                    <div class="flex gap-2">
                        <input type="text" id="detection-id-search" placeholder="Enter Detection ID to search..." class="input input-bordered w-full max-w-md" />
                        <button onclick="searchByDetectionId()" class="btn btn-neutral">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                            </svg>
                            Search
                        </button>
                    </div>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loading-state" class="hidden">
                <div class="flex items-center gap-3 p-4 bg-base-200 rounded-lg">
                    <span class="loading loading-spinner loading-md"></span>
                    <span>Searching for similar detections...</span>
                </div>
            </div>

            <!-- Error State -->
            <div id="error-state" class="hidden">
                <div class="alert alert-error">
                    <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span id="error-message">An error occurred while searching.</span>
                </div>
            </div>

            <!-- Search Results -->
            <div id="search-results" class="hidden">
                <!-- Source Detection Card -->
                <div id="source-detection-card" class="mb-6"></div>

                <!-- Similar Detections Timeline -->
                <h3 class="text-lg font-semibold mb-4">Person Movement Timeline</h3>
                <div id="timeline-container"></div>
            </div>

            <!-- Enhanced Empty State (shown when no search performed) -->
            <div id="empty-state" class="py-8">
                <div class="bg-gradient-to-br from-primary/5 to-secondary/5 rounded-xl p-8 border border-primary/20">
                    <div class="text-center mb-8">
                        <div class="flex items-center justify-center gap-3 mb-4">
                            <svg class="w-8 h-8 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                            </svg>
                            <h3 class="text-2xl font-bold text-primary">PERSON RE-IDENTIFICATION</h3>
                        </div>
                    </div>

                    <!-- Feature Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <!-- AI Detection Card -->
                        <div class="card bg-base-100 shadow-lg border border-primary/20">
                            <div class="card-body p-6 text-center">
                                <div class="flex justify-center mb-4">
                                    <div class="w-16 h-16 bg-primary/10 rounded-full flex items-center justify-center">
                                        <svg class="w-8 h-8 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                                        </svg>
                                    </div>
                                </div>
                                <h4 class="text-lg font-semibold text-primary mb-2">ðŸ‘¤ AI Detection</h4>
                                <p class="text-sm text-base-content/70 mb-3">Advanced matching algorithm</p>
                                <div class="text-xs text-base-content/60">
                                    Analyzes facial features and clothing patterns with high precision
                                </div>
                            </div>
                        </div>

                        <!-- Track Movement Card -->
                        <div class="card bg-base-100 shadow-lg border border-secondary/20">
                            <div class="card-body p-6 text-center">
                                <div class="flex justify-center mb-4">
                                    <div class="w-16 h-16 bg-secondary/10 rounded-full flex items-center justify-center">
                                        <svg class="w-8 h-8 text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                        </svg>
                                    </div>
                                </div>
                                <h4 class="text-lg font-semibold text-secondary mb-2">ðŸ”„ Track Movement</h4>
                                <p class="text-sm text-base-content/70 mb-3">Follow the person's journey</p>
                                <div class="text-xs text-base-content/60">
                                    Complete movement timeline across all camera locations
                                </div>
                            </div>
                        </div>

                        <!-- Analyze Patterns Card -->
                        <div class="card bg-base-100 shadow-lg border border-accent/20">
                            <div class="card-body p-6 text-center">
                                <div class="flex justify-center mb-4">
                                    <div class="w-16 h-16 bg-accent/10 rounded-full flex items-center justify-center">
                                        <svg class="w-8 h-8 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                                        </svg>
                                    </div>
                                </div>
                                <h4 class="text-lg font-semibold text-accent mb-2">ðŸ“Š Analyze Patterns</h4>
                                <p class="text-sm text-base-content/70 mb-3">Same-day detection analytics</p>
                                <div class="text-xs text-base-content/60">
                                    Statistical analysis and confidence scoring
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- How It Works Section -->
                    <div class="bg-base-100 rounded-lg p-6 border border-base-300">
                        <div class="flex items-center gap-2 mb-4">
                            <svg class="w-5 h-5 text-info" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <h4 class="text-lg font-semibold text-info">ðŸ’¡ How it works:</h4>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                            <div class="flex gap-3">
                                <div class="badge badge-primary badge-outline font-mono">1</div>
                                <div>Enter any Detection ID from your surveillance data</div>
                            </div>
                            <div class="flex gap-3">
                                <div class="badge badge-primary badge-outline font-mono">2</div>
                                <div>AI analyzes facial features and clothing patterns</div>
                            </div>
                            <div class="flex gap-3">
                                <div class="badge badge-primary badge-outline font-mono">3</div>
                                <div>System searches across all cameras for matches</div>
                            </div>
                            <div class="flex gap-3">
                                <div class="badge badge-primary badge-outline font-mono">4</div>
                                <div>View complete movement timeline with confidence scores</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
// Person Re-ID Search Functionality
async function searchByDetectionId() {
    const detectionId = document.getElementById('detection-id-search').value.trim();

    if (!detectionId) {
        showError('Please enter a Detection ID');
        return;
    }

    // Hide previous states
    hideAllStates();

    // Show loading state
    document.getElementById('loading-state').classList.remove('hidden');

    try {
        // Make API call to search for similar detections
        const response = await fetch(`/api/detections/search-similar/${detectionId}?threshold=0.7&top_k=50`);
        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.error || 'Failed to search for similar detections');
        }

        if (data.success) {
            displaySearchResults(data);
        } else {
            throw new Error(data.error || 'Search failed');
        }
    } catch (error) {
        console.error('Search error:', error);
        showError(error.message);
    } finally {
        document.getElementById('loading-state').classList.add('hidden');
    }
}

function displaySearchResults(data) {
    hideAllStates();

    // Show search results container
    document.getElementById('search-results').classList.remove('hidden');

    // Display source detection
    displaySourceDetection(data.source_detection);

    // Display timeline of similar detections
    displayTimeline(data.person_path || data.similar_detections);

    // Display search statistics
    if (data.search_params) {
        console.log('Search Statistics:', data.search_params);
    }
}

function displaySourceDetection(detection) {
    const sourceCard = document.getElementById('source-detection-card');

    const timestamp = detection.timestamp; // Already formatted on server

    sourceCard.innerHTML = `
        <div class="card bg-primary/10 border-primary">
            <div class="card-body">
                <h3 class="card-title">Source Detection #${detection.id}</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <img src="/api/detections/images/${detection.image_path}"
                             alt="Detection ${detection.id}"
                             class="w-full rounded-lg shadow-lg cursor-pointer"
                             onclick="openImageModal('${detection.image_path}')">
                    </div>
                    <div class="space-y-2">
                        <p><strong>Detection ID:</strong> ${detection.id}</p>
                        <p><strong>Person ID:</strong> ${detection.person_id || 'N/A'}</p>
                        <p><strong>Camera:</strong> ${detection.camera_name}</p>
                        <p><strong>Time:</strong> ${timestamp}</p>
                        <p><strong>Confidence:</strong> ${(detection.confidence * 100).toFixed(1)}%</p>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function displayTimeline(detections) {
    const timelineContainer = document.getElementById('timeline-container');

    if (!detections || detections.length === 0) {
        timelineContainer.innerHTML = '<p class="text-base-content/70">No similar detections found.</p>';
        return;
    }

    // Create timeline HTML
    let timelineHTML = '<ul class="timeline timeline-vertical">';

    detections.forEach((detection, index) => {
        const timestamp = detection.timestamp; // Already formatted on server
        const similarity = (detection.similarity * 100).toFixed(1);

        // Color code based on similarity
        let badgeColor = 'badge-success'; // >90%
        if (detection.similarity < 0.8) badgeColor = 'badge-warning'; // 70-80%
        else if (detection.similarity < 0.9) badgeColor = 'badge-info'; // 80-90%

        // Check if this is the source detection
        const isSource = detection.is_source;

        timelineHTML += `
            <li>
                ${index > 0 ? '<hr />' : ''}
                <div class="timeline-start timeline-box">
                    <div class="text-sm font-semibold">${timestamp}</div>
                </div>
                <div class="timeline-middle">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"
                         class="h-5 w-5 ${isSource ? 'text-primary' : 'text-success'}">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="timeline-end">
                    <div class="card bg-base-100 shadow-sm border border-base-300 max-w-lg">
                        <div class="card-body p-4">
                            <div class="flex gap-4">
                                <img src="/api/detections/images/${detection.image_path}"
                                     alt="Detection ${detection.id}"
                                     class="w-48 h-36 object-cover rounded cursor-pointer flex-shrink-0"
                                     onclick="openImageModal('${detection.image_path}')">
                                <div class="text-sm space-y-2 flex-1">
                                    <p>Camera: ${detection.camera_name}</p>
                                    <p>Detection ID: ${detection.id}</p>
                                    <p>Match confidence: ${similarity}%</p>
                                    <p>Detection confidence: ${(detection.confidence * 100).toFixed(1)}%</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                ${index < detections.length - 1 ? '<hr />' : ''}
            </li>
        `;
    });

    timelineHTML += '</ul>';

    // Add summary statistics
    const uniqueCameras = [...new Set(detections.map(d => d.camera_name))];
    const timeSpan = getTimeSpan(detections);

    timelineHTML = `
        <div class="stats shadow mb-4">
            <div class="stat">
                <div class="stat-title">Total Matches</div>
                <div class="stat-value text-primary">${detections.length}</div>
            </div>
            <div class="stat">
                <div class="stat-title">Cameras Visited</div>
                <div class="stat-value text-secondary">${uniqueCameras.length}</div>
            </div>
            <div class="stat">
                <div class="stat-title">Time Span</div>
                <div class="stat-value text-accent text-2xl">${timeSpan}</div>
            </div>
        </div>
    ` + timelineHTML;

    timelineContainer.innerHTML = timelineHTML;
}

function getTimeSpan(detections) {
    if (detections.length < 2) return 'N/A';

    const times = detections.map(d => new Date(d.timestamp).getTime());
    const minTime = Math.min(...times);
    const maxTime = Math.max(...times);
    const diffMs = maxTime - minTime;

    const hours = Math.floor(diffMs / (1000 * 60 * 60));
    const minutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));

    if (hours > 0) {
        return `${hours}h ${minutes}m`;
    } else {
        return `${minutes}m`;
    }
}

function openImageModal(imagePath) {
    // Create modal for full-size image viewing
    const modal = document.createElement('div');
    modal.className = 'modal modal-open';
    modal.innerHTML = `
        <div class="modal-box max-w-4xl">
            <h3 class="font-bold text-lg mb-4">Detection Image</h3>
            <img src="/api/detections/images/${imagePath}" alt="Detection" class="w-full rounded-lg">
            <div class="modal-action">
                <button class="btn" onclick="this.closest('.modal').remove()">Close</button>
            </div>
        </div>
        <div class="modal-backdrop" onclick="this.closest('.modal').remove()"></div>
    `;
    document.body.appendChild(modal);
}

function showError(message) {
    hideAllStates();
    const errorState = document.getElementById('error-state');
    const errorMessage = document.getElementById('error-message');
    errorMessage.textContent = message;
    errorState.classList.remove('hidden');
}

function hideAllStates() {
    document.getElementById('loading-state').classList.add('hidden');
    document.getElementById('error-state').classList.add('hidden');
    document.getElementById('search-results').classList.add('hidden');
    document.getElementById('empty-state').classList.add('hidden');
}

// Allow Enter key to trigger search
document.getElementById('detection-id-search').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        searchByDetectionId();
    }
});
</script>

{% endblock %}