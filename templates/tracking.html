{% extends "base.html" %}

{% block title %}Tracking - Svl App{% endblock %}

{% block content %}
<div class="container mx-auto py-6">
    <!-- Page Header -->
    <div class="mb-6">
        <h1 class="text-3xl font-bold text-base-content mb-2">Tracking</h1>
        <p class="text-base-content/70">Track events and activities over time</p>
    </div>

    <!-- Search by Detection ID Section -->
    <div class="card bg-base-100 shadow-sm border border-base-300 mb-6">
        <div class="card-body">
            <div class="flex items-center mb-4">
                <svg class="w-5 h-5 mr-3 text-base-content opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z"></path>
                </svg>
                <h2 class="card-title text-lg font-semibold">Search by Detection ID</h2>
            </div>

            <div class="form-control w-full max-w-md">
                <label class="label">
                    <span class="label-text font-medium">Detection ID</span>
                </label>
                <div class="flex gap-2">
                    <input type="text" id="detection-id-search" placeholder="Enter Detection ID to search..." class="input input-bordered w-full max-w-md" />
                    <button onclick="searchByDetectionId()" class="btn btn-neutral">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                        </svg>
                        Search
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Dynamic Timeline Container (initially empty) -->
    <div id="dynamic-timeline-container"></div>

</div>

<script>
// Function to create timeline card dynamically
function createTimelineCard() {
    const container = document.getElementById('dynamic-timeline-container');
    container.innerHTML = `
        <div class="card bg-base-100 shadow-sm border border-base-300">
            <div class="card-body">
                <h2 class="card-title text-lg font-semibold mb-4">Timeline</h2>

                <!-- Loading State -->
                <div id="loading-state" class="hidden">
                    <div class="flex items-center gap-3 p-4 bg-base-200 rounded-lg">
                        <span class="loading loading-spinner loading-md"></span>
                        <span>Searching for similar detections...</span>
                    </div>
                </div>

                <!-- Error State -->
                <div id="error-state" class="hidden">
                    <div class="alert alert-error">
                        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span id="error-message">An error occurred while searching.</span>
                    </div>
                </div>

                <!-- Search Results -->
                <div id="search-results" class="hidden">
                    <!-- Source Detection Card -->
                    <div id="source-detection-card" class="mb-6"></div>

                    <!-- Similar Detections Timeline -->
                    <h3 class="text-lg font-semibold mb-4">Person Movement Timeline</h3>
                    <div id="timeline-container"></div>
                </div>
            </div>
        </div>
    `;
}

// Person Re-ID Search Functionality
async function searchByDetectionId() {
    const detectionId = document.getElementById('detection-id-search').value.trim();

    if (!detectionId) {
        showError('Please enter a Detection ID');
        return;
    }

    // Create timeline card if it doesn't exist
    createTimelineCard();

    // Hide previous states
    hideAllStates();

    // Show loading state
    document.getElementById('loading-state').classList.remove('hidden');

    try {
        // Make API call to search for similar detections
        const response = await fetch(`/api/detections/search-similar/${detectionId}?threshold=0.7&top_k=50`);
        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.error || 'Failed to search for similar detections');
        }

        if (data.success) {
            displaySearchResults(data);
        } else {
            throw new Error(data.error || 'Search failed');
        }
    } catch (error) {
        console.error('Search error:', error);
        showError(error.message);
    } finally {
        document.getElementById('loading-state').classList.add('hidden');
    }
}

function displaySearchResults(data) {
    hideAllStates();

    // Show search results container
    document.getElementById('search-results').classList.remove('hidden');

    // Display source detection
    displaySourceDetection(data.source_detection);

    // Display timeline of similar detections
    displayTimeline(data.person_path || data.similar_detections);

    // Display search statistics
    if (data.search_params) {
        console.log('Search Statistics:', data.search_params);
    }
}

function displaySourceDetection(detection) {
    const sourceCard = document.getElementById('source-detection-card');

    const timestamp = detection.timestamp; // Already formatted on server

    sourceCard.innerHTML = `
        <h3 class="text-lg font-semibold mb-4">Source Detection #${detection.id}</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <img src="/api/detections/images/${detection.image_path}"
                     alt="Detection ${detection.id}"
                     class="w-full rounded-lg shadow-lg cursor-pointer"
                     onclick="openImageModal('${detection.image_path}')">
            </div>
            <div class="space-y-2">
                <p><strong>Detection ID:</strong> ${detection.id}</p>
                <p><strong>Person ID:</strong> ${detection.person_id || 'N/A'}</p>
                <p><strong>Camera:</strong> ${detection.camera_name}</p>
                <p><strong>Time:</strong> ${timestamp}</p>
                <p><strong>Confidence:</strong> ${(detection.confidence * 100).toFixed(1)}%</p>
            </div>
        </div>
    `;
}

function displayTimeline(detections) {
    const timelineContainer = document.getElementById('timeline-container');

    if (!detections || detections.length === 0) {
        timelineContainer.innerHTML = '<p class="text-base-content/70">No similar detections found.</p>';
        return;
    }

    // Create timeline HTML
    let timelineHTML = '<ul class="timeline timeline-vertical">';

    detections.forEach((detection, index) => {
        const timestamp = detection.timestamp; // Already formatted on server
        const similarity = (detection.similarity * 100).toFixed(1);

        // Color code based on similarity
        let badgeColor = 'badge-success'; // >90%
        if (detection.similarity < 0.8) badgeColor = 'badge-warning'; // 70-80%
        else if (detection.similarity < 0.9) badgeColor = 'badge-info'; // 80-90%

        // Check if this is the source detection
        const isSource = detection.is_source;

        timelineHTML += `
            <li>
                ${index > 0 ? '<hr />' : ''}
                <div class="timeline-start timeline-box">
                    <div class="text-sm font-semibold">${timestamp}</div>
                </div>
                <div class="timeline-middle">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"
                         class="h-5 w-5 ${isSource ? 'text-primary' : 'text-success'}">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="timeline-end">
                    <div class="card bg-base-100 shadow-sm border border-base-300 max-w-lg">
                        <div class="card-body p-4">
                            <div class="flex gap-4">
                                <img src="/api/detections/images/${detection.image_path}"
                                     alt="Detection ${detection.id}"
                                     class="w-48 h-36 object-cover rounded cursor-pointer flex-shrink-0"
                                     onclick="openImageModal('${detection.image_path}')">
                                <div class="text-sm space-y-2 flex-1">
                                    <p>Camera: ${detection.camera_name}</p>
                                    <p>Detection ID: ${detection.id}</p>
                                    <p>Match confidence: ${similarity}%</p>
                                    <p>Detection confidence: ${(detection.confidence * 100).toFixed(1)}%</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                ${index < detections.length - 1 ? '<hr />' : ''}
            </li>
        `;
    });

    timelineHTML += '</ul>';

    // Add summary statistics
    const uniqueCameras = [...new Set(detections.map(d => d.camera_name))];
    const timeSpan = getTimeSpan(detections);

    timelineHTML = `
        <div class="stats shadow mb-4">
            <div class="stat">
                <div class="stat-title">Total Matches</div>
                <div class="stat-value text-primary">${detections.length}</div>
            </div>
            <div class="stat">
                <div class="stat-title">Cameras Visited</div>
                <div class="stat-value text-secondary">${uniqueCameras.length}</div>
            </div>
            <div class="stat">
                <div class="stat-title">Time Span</div>
                <div class="stat-value text-accent text-2xl">${timeSpan}</div>
            </div>
        </div>
    ` + timelineHTML;

    timelineContainer.innerHTML = timelineHTML;
}

function getTimeSpan(detections) {
    if (detections.length < 2) return 'N/A';

    const times = detections.map(d => new Date(d.timestamp).getTime());
    const minTime = Math.min(...times);
    const maxTime = Math.max(...times);
    const diffMs = maxTime - minTime;

    const hours = Math.floor(diffMs / (1000 * 60 * 60));
    const minutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));

    if (hours > 0) {
        return `${hours}h ${minutes}m`;
    } else {
        return `${minutes}m`;
    }
}

function openImageModal(imagePath) {
    // Create modal for full-size image viewing
    const modal = document.createElement('div');
    modal.className = 'modal modal-open';
    modal.innerHTML = `
        <div class="modal-box max-w-4xl">
            <h3 class="font-bold text-lg mb-4">Detection Image</h3>
            <img src="/api/detections/images/${imagePath}" alt="Detection" class="w-full rounded-lg">
            <div class="modal-action">
                <button class="btn" onclick="this.closest('.modal').remove()">Close</button>
            </div>
        </div>
        <div class="modal-backdrop" onclick="this.closest('.modal').remove()"></div>
    `;
    document.body.appendChild(modal);
}

function showError(message) {
    // Create timeline card if it doesn't exist
    createTimelineCard();

    hideAllStates();
    const errorState = document.getElementById('error-state');
    const errorMessage = document.getElementById('error-message');
    errorMessage.textContent = message;
    errorState.classList.remove('hidden');
}

function hideAllStates() {
    // Safely hide elements if they exist
    const loadingState = document.getElementById('loading-state');
    if (loadingState) loadingState.classList.add('hidden');

    const errorState = document.getElementById('error-state');
    if (errorState) errorState.classList.add('hidden');

    const searchResults = document.getElementById('search-results');
    if (searchResults) searchResults.classList.add('hidden');
}

// Allow Enter key to trigger search
document.getElementById('detection-id-search').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        searchByDetectionId();
    }
});
</script>

{% endblock %}