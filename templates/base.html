<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Svl App{% endblock %}</title>
    <link href="{{ url_for('static', filename='css/tailwind.min.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/daisyui.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/custom.css') }}" rel="stylesheet">
</head>
<body>
    <div class="drawer lg:drawer-open">
        <input id="my-drawer-2" type="checkbox" class="drawer-toggle" />
        <div class="drawer-content flex flex-col">
            <!-- Page content here -->
            <main class="flex-1 bg-base-100">
                <div class="container mx-auto py-4">
                    {% block content %}{% endblock %}
                </div>
            </main>
        </div>
        <div class="drawer-side">
            <label for="my-drawer-2" aria-label="close sidebar" class="drawer-overlay"></label>
            <ul class="menu bg-base-200 text-base-content min-h-full w-40 p-4">
                <!-- Header -->
                <li class="menu-title">
                    <span>Svl App</span>
                </li>
                <!-- Sidebar content here -->
                <li>
                    <details>
                        <summary>Feed</summary>
                        <ul>
                            <li><a href="/feed">Camera Feed</a></li>
                            <li><a href="#" onclick="addCameraModal.showModal()">Add Camera</a></li>
                        </ul>
                    </details>
                </li>
                <li>
                    <a href="/sensor-analytics">Sensor Analytics</a>
                </li>
            </ul>
        </div>
    </div>

    <!-- Add Camera Modal -->
    <dialog id="addCameraModal" class="modal">
        <div class="modal-box w-11/12 max-w-none relative">
            <form method="dialog">
                <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
            </form>
            <h3 class="font-bold text-lg mb-4">Add New Camera</h3>
                    <form id="addCameraForm">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="form-control">
                                <label for="uniqueId" class="label"><span class="label-text">Unique ID <span class="text-error">*</span></span></label>
                                <input type="text" class="input input-bordered w-full" id="uniqueId" name="uniqueId" 
                                       placeholder="e.g., camera_lobby_01, cam_entrance_main" 
                                       pattern="[a-zA-Z0-9_-]+" 
                                       title="Only letters, numbers, underscores, and hyphens allowed" 
                                       required>
                            </div>
                            <div class="form-control">
                                <label for="rtspUrl" class="label"><span class="label-text">RTSP URL <span class="text-error">*</span></span></label>
                                <input type="url" class="input input-bordered w-full" id="rtspUrl" name="rtspUrl" placeholder="rtsp://192.168.1.100:554/stream" required>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="form-control">
                                <label for="cameraName" class="label"><span class="label-text">Camera Name</span></label>
                                <input type="text" class="input input-bordered w-full" id="cameraName" name="cameraName" placeholder="e.g., UAV Feed, LORROS Feed (Optional)">
                            </div>
                            <div class="form-control">
                                <!-- Empty slot for layout symmetry -->
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="form-control">
                                <label for="username" class="label"><span class="label-text">Username</span></label>
                                <input type="text" class="input input-bordered w-full" id="username" name="username" placeholder="admin">
                            </div>
                            <div class="form-control">
                                <label for="password" class="label"><span class="label-text">Password</span></label>
                                <input type="password" class="input input-bordered w-full" id="password" name="password" placeholder="••••••••">
                            </div>
                        </div>


                        <!-- Connection Test Status -->
                        <div id="connectionStatus" class="hidden" style="margin-top: 1.5rem;" role="alert"></div>
                    </form>
                    
                    <div class="modal-action">
                        <button type="button" class="btn" id="testConnection">
                            Test Connection
                        </button>
                        <button type="button" class="btn btn-neutral" id="addCameraBtn">
                            Add Camera
                        </button>
                    </div>
        </div>
    </dialog>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const testConnectionBtn = document.getElementById('testConnection');
        const addCameraBtn = document.getElementById('addCameraBtn');
        const connectionStatus = document.getElementById('connectionStatus');
        const addCameraForm = document.getElementById('addCameraForm');
        
        // Test Connection functionality
        testConnectionBtn.addEventListener('click', async function() {
            const rtspUrl = document.getElementById('rtspUrl').value.trim();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();

            if (!rtspUrl) {
                alert('Please enter an RTSP URL first.');
                return;
            }

            connectionStatus.className = 'alert alert-info';
            connectionStatus.innerHTML = `
                <div class="flex items-center">
                    <div class="loading loading-spinner loading-sm mr-2" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                    Testing connection to ${rtspUrl}...
                </div>
            `;
            connectionStatus.classList.remove('hidden');

            try {
                const response = await fetch('/api/cameras/test-connection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        rtsp_url: rtspUrl,
                        username: username,
                        password: password
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    connectionStatus.className = 'alert alert-success';
                    connectionStatus.innerHTML = `
                        <div class="flex items-center">
                            <span class="mr-2">✅</span>
                            ${result.message}
                            ${result.frame_shape ? `<br><small>Frame resolution: ${result.frame_shape[1]}x${result.frame_shape[0]}</small>` : ''}
                        </div>
                    `;
                } else {
                    connectionStatus.className = 'alert alert-error';
                    connectionStatus.innerHTML = `
                        <div class="flex items-center">
                            ${result.error}
                        </div>
                    `;
                }
            } catch (error) {
                connectionStatus.className = 'alert alert-error';
                connectionStatus.innerHTML = `
                    <div class="flex items-center">
                        Network error: ${error.message}
                    </div>
                `;
            }
        });

        // Add Camera functionality
        addCameraBtn.addEventListener('click', async function() {
            const formData = new FormData(addCameraForm);
            const cameraData = {
                name: formData.get('cameraName').trim() || null,
                unique_id: formData.get('uniqueId').trim(),
                rtsp_url: formData.get('rtspUrl').trim(),
                username: formData.get('username').trim(),
                password: formData.get('password').trim(),
                auto_start: true
            };

            if (!cameraData.unique_id || !cameraData.rtsp_url) {
                alert('Please fill in all required fields (Unique ID and RTSP URL).');
                return;
            }

            // Validate unique_id format
            if (!/^[a-zA-Z0-9_-]+$/.test(cameraData.unique_id)) {
                alert('Unique ID can only contain letters, numbers, underscores, and hyphens.');
                return;
            }

            try {
                const response = await fetch('/api/cameras', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(cameraData)
                });

                const result = await response.json();
                
                if (result.success) {
                    // Clear form and close modal
                    addCameraForm.reset();
                    connectionStatus.classList.add('hidden');
                    
                    document.getElementById('addCameraModal').close();
                    
                    // Refresh page to show new camera (visual feedback is sufficient)
                    setTimeout(() => location.reload(), 500);
                } else {
                    showNotification(`Error: ${result.error}`, 'danger');
                }
            } catch (error) {
                showNotification(`Network error: ${error.message}`, 'danger');
            }
        });

        function showNotification(message, type) {
            // Map Bootstrap types to DaisyUI types
            const typeMap = {
                'success': 'alert-success',
                'danger': 'alert-error',
                'warning': 'alert-warning',
                'info': 'alert-info'
            };
            
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${typeMap[type] || 'alert-info'} fixed top-4 left-1/2 transform -translate-x-1/2 z-50 max-w-md shadow-lg`;
            alertDiv.innerHTML = `
                <div class="flex items-center justify-between">
                    <span>${message}</span>
                    <button type="button" class="btn btn-sm btn-circle btn-ghost" onclick="this.parentElement.parentElement.remove()">✕</button>
                </div>
            `;
            
            document.body.appendChild(alertDiv);
            
            // Auto remove after 4 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 4000);
        }
    });
    </script>

</body>
</html>