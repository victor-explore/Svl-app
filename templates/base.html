<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Drishthi{% endblock %}</title>
    <link href="{{ url_for('static', filename='css/tailwind.min.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/daisyui.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/custom.css') }}" rel="stylesheet">
</head>
<body class="min-h-screen flex flex-col">
    <!-- Horizontal Navbar -->
    <div class="navbar bg-base-100 border-b border-base-300 shadow-md">
        <div class="flex-1">
            <a class="btn btn-ghost normal-case text-2xl font-bold text-base-content">
                AI Based Surveillance System
            </a>
        </div>
        <div class="flex-none">
            <ul class="menu menu-horizontal px-1">
                <li><a href="/">Home</a></li>
                <li><a href="/feed">Feed</a></li>
                <li><a href="/map">Map</a></li>
                <li><a href="/sensor-analytics">Analysis</a></li>
                <li><a href="/tracking">Tracking</a></li>
                <li><a href="/settings">Settings</a></li>
            </ul>
        </div>
    </div>

    <!-- Main Content -->
    <main class="flex-1 bg-base-100">
        <div class="container mx-auto py-4">
            {% block content %}{% endblock %}
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer footer-center p-4 bg-base-200 text-base-content border-t border-base-300 mt-auto">
        <div>
            <p>Developed by AI Lab 1 CGSR</p>
        </div>
    </footer>

    <!-- Add Camera Modal -->
    <dialog id="addCameraModal" class="modal">
        <div class="modal-box w-11/12 max-w-none relative">
            <form method="dialog">
                <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">âœ•</button>
            </form>
            <h3 class="font-bold text-lg mb-4">Add New Svl Device</h3>
                    <form id="addCameraForm">
                        <!-- Common fields for both camera types -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="form-control">
                                <label for="uniqueId" class="label"><span class="label-text">Unique ID <span class="text-error">*</span></span></label>
                                <input type="text" class="input input-bordered w-full" id="uniqueId" name="uniqueId"
                                       placeholder="e.g., camera_lobby_01, cam_entrance_main"
                                       pattern="[a-zA-Z0-9_-]+"
                                       title="Only letters, numbers, underscores, and hyphens allowed"
                                       required>
                            </div>
                            <div class="form-control">
                                <label for="cameraName" class="label"><span class="label-text">Svl Device Name</span></label>
                                <input type="text" class="input input-bordered w-full" id="cameraName" name="cameraName" placeholder="e.g., UAV Feed, LORROS Feed (Optional)">
                            </div>
                        </div>

                        <!-- Accordion for Camera Type Selection -->
                        <div class="mt-4">
                            <div class="text-sm text-base-content/70 mb-2">Select camera type:</div>

                            <!-- RTSP Network Camera Section -->
                            <div class="collapse collapse-arrow bg-base-100 border border-base-300">
                                <input type="radio" name="camera-type-accordion" id="rtspAccordion" value="rtsp" checked />
                                <div class="collapse-title font-semibold">
                                    <span class="text-base">ðŸ“¡ RTSP Network Camera</span>
                                    <div class="text-sm font-normal text-base-content/70">Connect to IP cameras via RTSP stream</div>
                                </div>
                                <div class="collapse-content">
                                    <div class="grid grid-cols-1 gap-4 pt-2">
                                        <div class="form-control">
                                            <label for="rtspUrl" class="label"><span class="label-text">RTSP URL <span class="text-error">*</span></span></label>
                                            <input type="url" class="input input-bordered w-full" id="rtspUrl" name="rtspUrl" placeholder="rtsp://192.168.1.100:554/stream">
                                        </div>
                                    </div>

                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div class="form-control">
                                            <label for="username" class="label"><span class="label-text">Username</span></label>
                                            <input type="text" class="input input-bordered w-full" id="username" name="username" placeholder="admin">
                                        </div>
                                        <div class="form-control">
                                            <label for="password" class="label"><span class="label-text">Password</span></label>
                                            <input type="password" class="input input-bordered w-full" id="password" name="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                                        </div>
                                    </div>

                                    <!-- Save Camera Checkbox -->
                                    <div class="form-control mt-2">
                                        <label class="label cursor-pointer justify-start">
                                            <input type="checkbox" class="checkbox checkbox-sm mr-2" id="saveCamera" name="saveCamera">
                                            <span class="label-text">Save this camera for future use</span>
                                        </label>
                                    </div>

                                    <!-- Divider -->
                                    <div class="divider my-2">OR</div>

                                    <!-- Saved Cameras Dropdown -->
                                    <div class="form-control">
                                        <label for="savedCameraSelect" class="label">
                                            <span class="label-text">Select saved camera:</span>
                                        </label>
                                        <select class="select select-bordered w-full" id="savedCameraSelect" name="savedCameraSelect">
                                            <option value="">Select Saved Camera...</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- USB Camera Section -->
                            <div class="collapse collapse-arrow bg-base-100 border border-base-300 mt-2">
                                <input type="radio" name="camera-type-accordion" id="usbAccordion" value="usb" />
                                <div class="collapse-title font-semibold">
                                    <span class="text-base">ðŸŽ¥ USB Camera</span>
                                    <div class="text-sm font-normal text-base-content/70">Connect to locally attached USB cameras</div>
                                </div>
                                <div class="collapse-content">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-2">
                                        <div class="form-control">
                                            <label for="deviceIndex" class="label">
                                                <span class="label-text">USB Camera Device <span class="text-error">*</span></span>
                                            </label>
                                            <select class="select select-bordered w-full" id="deviceIndex" name="deviceIndex">
                                                <option value="">Select USB Camera...</option>
                                                <option value="0">Camera 0</option>
                                                <option value="1">Camera 1</option>
                                                <option value="2">Camera 2</option>
                                                <option value="3">Camera 3</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div id="usbDeviceInfo" class="alert alert-info mt-2 hidden">
                                        <div class="text-sm"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Location fields (optional for both types) -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                            <div class="form-control">
                                <label for="latitude" class="label">
                                    <span class="label-text">Latitude</span>
                                </label>
                                <input type="number" step="any" class="input input-bordered w-full" id="latitude" name="latitude"
                                       placeholder="e.g., 40.7589" min="-90" max="90">
                            </div>
                            <div class="form-control">
                                <label for="longitude" class="label">
                                    <span class="label-text">Longitude</span>
                                </label>
                                <input type="number" step="any" class="input input-bordered w-full" id="longitude" name="longitude"
                                       placeholder="e.g., -73.9851" min="-180" max="180">
                            </div>
                        </div>


                        <!-- Connection Test Status -->
                        <div id="connectionStatus" class="hidden" style="margin-top: 1.5rem;" role="alert"></div>
                    </form>
                    
                    <div class="modal-action">
                        <button type="button" class="btn" id="testConnection">
                            Test Connection
                        </button>
                        <button type="button" class="btn btn-neutral" id="addCameraBtn">
                            Add Svl Device
                        </button>
                    </div>
        </div>
    </dialog>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const testConnectionBtn = document.getElementById('testConnection');
        const addCameraBtn = document.getElementById('addCameraBtn');
        const connectionStatus = document.getElementById('connectionStatus');
        const addCameraForm = document.getElementById('addCameraForm');
        const rtspAccordion = document.getElementById('rtspAccordion');
        const usbAccordion = document.getElementById('usbAccordion');
        const deviceIndexSelect = document.getElementById('deviceIndex');
        const usbDeviceInfo = document.getElementById('usbDeviceInfo');
        const savedCameraSelect = document.getElementById('savedCameraSelect');
        const saveCameraCheckbox = document.getElementById('saveCamera');

        // Load saved cameras on page load
        loadSavedCameras();

        // Handle saved camera selection
        savedCameraSelect.addEventListener('change', function() {
            const selectedId = this.value;
            if (!selectedId) return;

            // Find the selected camera data
            const selectedOption = this.options[this.selectedIndex];
            const cameraData = JSON.parse(selectedOption.dataset.camera || '{}');

            // Populate RTSP fields
            document.getElementById('rtspUrl').value = cameraData.rtsp_url || '';
            document.getElementById('username').value = cameraData.username || '';
            document.getElementById('password').value = cameraData.password || '';
            document.getElementById('cameraName').value = cameraData.name || '';
            document.getElementById('uniqueId').value = cameraData.unique_id || '';

            // Populate location fields if available
            document.getElementById('latitude').value = cameraData.latitude || '';
            document.getElementById('longitude').value = cameraData.longitude || '';

            // Uncheck save checkbox since this is already saved
            saveCameraCheckbox.checked = false;
        });

        // Handle accordion radio button changes
        function updateFieldRequirements() {
            const isUsb = usbAccordion.checked;

            if (isUsb) {
                // Make USB fields required, RTSP fields optional
                document.getElementById('rtspUrl').removeAttribute('required');
                document.getElementById('deviceIndex').setAttribute('required', 'required');
            } else {
                // Make RTSP fields required, USB fields optional
                document.getElementById('rtspUrl').setAttribute('required', 'required');
                document.getElementById('deviceIndex').removeAttribute('required');
            }

            // Clear connection status when switching types
            connectionStatus.classList.add('hidden');
        }

        // Set up accordion change listeners
        rtspAccordion.addEventListener('change', function() {
            if (this.checked) {
                updateFieldRequirements();
            }
        });

        usbAccordion.addEventListener('change', function() {
            if (this.checked) {
                updateFieldRequirements();
                // Load USB devices when USB section is opened (with loading indicator)
                loadUsbDevices(true);
            }
        });

        // Initialize field requirements based on default selection
        updateFieldRequirements();

        // USB device detection with loading indicator
        let usbScanInProgress = false;

        async function loadUsbDevices(showLoading = true) {
            // Prevent multiple simultaneous scans
            if (usbScanInProgress) {
                console.log('USB scan already in progress, skipping...');
                return;
            }

            usbScanInProgress = true;

            try {
                if (showLoading) {
                    // Show loading indicator immediately
                    usbDeviceInfo.classList.remove('hidden');
                    usbDeviceInfo.className = 'alert alert-info mt-2';
                    usbDeviceInfo.querySelector('div').innerHTML = `
                        <span class="loading loading-spinner loading-xs"></span>
                        <span class="ml-2">Detecting USB cameras...</span>
                    `;
                }

                const startTime = performance.now();
                const response = await fetch('/api/usb-devices');
                const result = await response.json();
                const scanTime = performance.now() - startTime;

                if (result.success) {
                    deviceIndexSelect.innerHTML = '<option value="">Select USB Camera...</option>';

                    if (result.devices.length === 0) {
                        usbDeviceInfo.classList.remove('hidden');
                        usbDeviceInfo.querySelector('div').innerHTML = 'No USB cameras detected. Please connect a USB camera and refresh.';
                        usbDeviceInfo.className = 'alert alert-warning mt-2';
                    } else {
                        result.devices.forEach(device => {
                            const option = document.createElement('option');
                            option.value = device.index;

                            // Handle quick scan vs full scan display
                            let resolutionText = device.resolution;
                            if (resolutionText === 'Quick scan') {
                                resolutionText = 'Device ' + device.index;
                            }

                            option.textContent = `${device.name} (${resolutionText})`;
                            if (device.in_use) {
                                option.textContent += ' [IN USE]';
                                option.disabled = true;
                            }
                            deviceIndexSelect.appendChild(option);
                        });

                        usbDeviceInfo.classList.remove('hidden');
                        const scanInfo = result.scan_mode === 'quick' ? ' (Quick scan)' : '';
                        const timeInfo = scanTime < 1000 ? ` in ${Math.round(scanTime)}ms` : '';
                        usbDeviceInfo.querySelector('div').innerHTML = `Found ${result.devices.length} USB camera(s)${scanInfo}${timeInfo}`;
                        usbDeviceInfo.className = 'alert alert-success mt-2';
                    }
                } else {
                    usbDeviceInfo.classList.remove('hidden');
                    usbDeviceInfo.querySelector('div').innerHTML = 'Error detecting USB cameras';
                    usbDeviceInfo.className = 'alert alert-error mt-2';
                }
            } catch (error) {
                console.error('Error loading USB devices:', error);
                usbDeviceInfo.classList.remove('hidden');
                usbDeviceInfo.querySelector('div').innerHTML = 'Network error detecting USB cameras';
                usbDeviceInfo.className = 'alert alert-error mt-2';
            } finally {
                usbScanInProgress = false;
            }
        }

        // Test Connection functionality
        testConnectionBtn.addEventListener('click', async function() {
            // Determine camera type from accordion selection
            const cameraType = usbAccordion.checked ? 'usb' : 'rtsp';
            let testData = { camera_type: cameraType };

            if (cameraType === 'usb') {
                const deviceIndex = document.getElementById('deviceIndex').value;
                if (!deviceIndex) {
                    alert('Please select a USB camera device.');
                    return;
                }
                testData.device_index = parseInt(deviceIndex);
            } else {
                const rtspUrl = document.getElementById('rtspUrl').value.trim();
                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value.trim();

                if (!rtspUrl) {
                    alert('Please enter an RTSP URL first.');
                    return;
                }
                testData.rtsp_url = rtspUrl;
                testData.username = username;
                testData.password = password;
            }

            const connectionMessage = cameraType === 'usb'
                ? `Testing USB camera device ${testData.device_index}...`
                : `Testing connection to ${testData.rtsp_url}...`;

            connectionStatus.className = 'alert alert-info';
            connectionStatus.innerHTML = `
                <div class="flex items-center">
                    <div class="loading loading-spinner loading-sm mr-2" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                    ${connectionMessage}
                </div>
            `;
            connectionStatus.classList.remove('hidden');

            try {
                const response = await fetch('/api/cameras/test-connection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testData)
                });

                const result = await response.json();
                
                if (result.success) {
                    connectionStatus.className = 'alert alert-success';
                    connectionStatus.innerHTML = `
                        <div class="flex items-center">
                            <span class="mr-2">âœ…</span>
                            ${result.message}
                            ${result.frame_shape ? `<br><small>Frame resolution: ${result.frame_shape[1]}x${result.frame_shape[0]}</small>` : ''}
                        </div>
                    `;
                } else {
                    connectionStatus.className = 'alert alert-error';
                    connectionStatus.innerHTML = `
                        <div class="flex items-center">
                            ${result.error}
                        </div>
                    `;
                }
            } catch (error) {
                connectionStatus.className = 'alert alert-error';
                connectionStatus.innerHTML = `
                    <div class="flex items-center">
                        Network error: ${error.message}
                    </div>
                `;
            }
        });

        // Add Camera functionality
        addCameraBtn.addEventListener('click', async function() {
            const formData = new FormData(addCameraForm);
            // Determine camera type from accordion selection
            const cameraType = usbAccordion.checked ? 'usb' : 'rtsp';
            const latitude = formData.get('latitude')?.trim();
            const longitude = formData.get('longitude')?.trim();

            const cameraData = {
                name: formData.get('cameraName').trim() || null,
                unique_id: formData.get('uniqueId').trim(),
                camera_type: cameraType,
                latitude: latitude && latitude !== '' ? parseFloat(latitude) : null,
                longitude: longitude && longitude !== '' ? parseFloat(longitude) : null,
                auto_start: true
            };

            // Add type-specific fields
            if (cameraType === 'usb') {
                const deviceIndex = formData.get('deviceIndex');
                if (!deviceIndex) {
                    alert('Please select a USB camera device.');
                    return;
                }
                cameraData.device_index = parseInt(deviceIndex);
            } else {
                cameraData.rtsp_url = formData.get('rtspUrl').trim();
                cameraData.username = formData.get('username').trim();
                cameraData.password = formData.get('password').trim();

                if (!cameraData.rtsp_url) {
                    alert('Please enter an RTSP URL.');
                    return;
                }
            }

            if (!cameraData.unique_id) {
                alert('Please enter a Unique ID.');
                return;
            }

            // Validate unique_id format
            if (!/^[a-zA-Z0-9_-]+$/.test(cameraData.unique_id)) {
                alert('Unique ID can only contain letters, numbers, underscores, and hyphens.');
                return;
            }

            try {
                // If save camera checkbox is checked and it's an RTSP camera, save the configuration
                if (cameraType === 'rtsp' && saveCameraCheckbox.checked) {
                    const saveName = cameraData.name || cameraData.unique_id;
                    await saveCameraConfiguration(
                        saveName,
                        cameraData.rtsp_url,
                        cameraData.username,
                        cameraData.password,
                        cameraData.latitude,
                        cameraData.longitude,
                        cameraData.unique_id
                    );
                }

                const response = await fetch('/api/cameras', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(cameraData)
                });

                const result = await response.json();

                if (result.success) {
                    // Clear form and close modal
                    addCameraForm.reset();
                    connectionStatus.classList.add('hidden');

                    document.getElementById('addCameraModal').close();

                    // Refresh page to show new camera (visual feedback is sufficient)
                    setTimeout(() => location.reload(), 500);
                } else {
                    showNotification(`Error: ${result.error}`, 'danger');
                }
            } catch (error) {
                showNotification(`Network error: ${error.message}`, 'danger');
            }
        });

        async function loadSavedCameras() {
            try {
                const response = await fetch('/api/saved-cameras');
                const result = await response.json();

                if (result.success && result.cameras.length > 0) {
                    // Clear existing options except the first one
                    savedCameraSelect.innerHTML = '<option value="">Select Saved Camera...</option>';

                    // Add saved cameras to dropdown
                    result.cameras.forEach(camera => {
                        const option = document.createElement('option');
                        option.value = camera.id;
                        option.textContent = camera.name;
                        option.dataset.camera = JSON.stringify(camera);
                        savedCameraSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading saved cameras:', error);
            }
        }

        async function saveCameraConfiguration(name, rtspUrl, username, password, latitude, longitude, uniqueId) {
            try {
                const saveData = {
                    name: name,
                    unique_id: uniqueId,
                    rtsp_url: rtspUrl,
                    username: username,
                    password: password,
                    latitude: latitude,
                    longitude: longitude
                };

                console.log('Saving camera configuration:', saveData);

                const response = await fetch('/api/saved-cameras', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(saveData)
                });

                const result = await response.json();

                if (result.success) {
                    console.log('âœ“ Camera configuration saved successfully (with location)');
                    // Reload saved cameras to update dropdown
                    await loadSavedCameras();
                } else {
                    console.error('âœ— Failed to save camera configuration:', result.error);
                    // Show error to user so they know what went wrong
                    showNotification(`Could not save camera: ${result.error}`, 'warning');
                }
            } catch (error) {
                console.error('âœ— Error saving camera configuration:', error);
                showNotification(`Error saving camera: ${error.message}`, 'warning');
            }
        }

        function showNotification(message, type) {
            // Map Bootstrap types to DaisyUI types
            const typeMap = {
                'success': 'alert-success',
                'danger': 'alert-error',
                'warning': 'alert-warning',
                'info': 'alert-info'
            };

            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${typeMap[type] || 'alert-info'} fixed top-4 left-1/2 transform -translate-x-1/2 z-50 max-w-md shadow-lg`;
            alertDiv.innerHTML = `
                <div class="flex items-center justify-between">
                    <span>${message}</span>
                    <button type="button" class="btn btn-sm btn-circle btn-ghost" onclick="this.parentElement.parentElement.remove()">âœ•</button>
                </div>
            `;

            document.body.appendChild(alertDiv);

            // Auto remove after 4 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 4000);
        }

        // Handle modal opening - reset to RTSP by default
        const addCameraModal = document.getElementById('addCameraModal');
        if (addCameraModal) {
            // Listen for when modal is shown
            const originalShowModal = addCameraModal.showModal;
            addCameraModal.showModal = function() {
                // Reset accordion to RTSP
                rtspAccordion.checked = true;
                usbAccordion.checked = false;

                // Update field requirements
                updateFieldRequirements();

                // Clear connection status
                connectionStatus.classList.add('hidden');

                // Clear USB device info if it was shown
                usbDeviceInfo.classList.add('hidden');

                // Reset saved camera dropdown
                savedCameraSelect.value = '';

                // Uncheck save camera checkbox
                saveCameraCheckbox.checked = false;

                // Reload saved cameras to get latest list
                loadSavedCameras();

                // Pre-scan USB devices in background (no loading indicator)
                // This makes the USB section feel instant when opened
                setTimeout(() => {
                    if (!usbScanInProgress) {
                        loadUsbDevices(false);  // Silent background scan
                    }
                }, 100);

                // Call original showModal
                originalShowModal.call(this);
            };
        }
    });
    </script>

</body>
</html>