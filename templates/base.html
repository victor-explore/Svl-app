<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Drishthi{% endblock %}</title>
    <link href="{{ url_for('static', filename='css/tailwind.min.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/daisyui.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/custom.css') }}" rel="stylesheet">
</head>
<body class="min-h-screen flex flex-col">
    <!-- Horizontal Navbar -->
    <div class="navbar bg-base-100 border-b border-base-300 shadow-md">
        <div class="flex-1">
            <a class="btn btn-ghost">
                <img src="{{ url_for('static', filename='Logo.png') }}" alt="Drishthi" class="h-8">
            </a>
        </div>
        <div class="flex-none">
            <ul class="menu menu-horizontal px-1">
                <li><a href="/feed">Feed</a></li>
                <li><a href="/map">Map</a></li>
                <li><a href="/sensor-analytics">Analysis</a></li>
                <li><a href="/tracking">Tracking</a></li>
                <li><a href="/settings">Settings</a></li>
            </ul>
        </div>
    </div>

    <!-- Main Content -->
    <main class="flex-1 bg-base-100">
        <div class="container mx-auto py-4">
            {% block content %}{% endblock %}
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer footer-center p-4 bg-base-200 text-base-content border-t border-base-300 mt-auto">
        <div>
            <p>Developed by AI Lab 1 CGSR</p>
        </div>
    </footer>

    <!-- Add Camera Modal -->
    <dialog id="addCameraModal" class="modal">
        <div class="modal-box w-11/12 max-w-none relative">
            <form method="dialog">
                <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">âœ•</button>
            </form>
            <h3 class="font-bold text-lg mb-4">Add New Svl Device</h3>
                    <form id="addCameraForm">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="form-control">
                                <label for="cameraType" class="label"><span class="label-text">Camera Type <span class="text-error">*</span></span></label>
                                <select class="select select-bordered w-full" id="cameraType" name="cameraType" required>
                                    <option value="rtsp">RTSP Network Camera</option>
                                    <option value="usb">USB Camera</option>
                                </select>
                            </div>
                            <div class="form-control">
                                <label for="uniqueId" class="label"><span class="label-text">Unique ID <span class="text-error">*</span></span></label>
                                <input type="text" class="input input-bordered w-full" id="uniqueId" name="uniqueId"
                                       placeholder="e.g., camera_lobby_01, cam_entrance_main"
                                       pattern="[a-zA-Z0-9_-]+"
                                       title="Only letters, numbers, underscores, and hyphens allowed"
                                       required>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 gap-4">
                            <div class="form-control">
                                <label for="cameraName" class="label"><span class="label-text">Svl Device Name</span></label>
                                <input type="text" class="input input-bordered w-full" id="cameraName" name="cameraName" placeholder="e.g., UAV Feed, LORROS Feed (Optional)">
                            </div>
                        </div>

                        <!-- RTSP-specific fields -->
                        <div id="rtspFields">
                            <div class="grid grid-cols-1 gap-4">
                                <div class="form-control">
                                    <label for="rtspUrl" class="label"><span class="label-text">RTSP URL <span class="text-error">*</span></span></label>
                                    <input type="url" class="input input-bordered w-full" id="rtspUrl" name="rtspUrl" placeholder="rtsp://192.168.1.100:554/stream">
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="form-control">
                                    <label for="username" class="label"><span class="label-text">Username</span></label>
                                    <input type="text" class="input input-bordered w-full" id="username" name="username" placeholder="admin">
                                </div>
                                <div class="form-control">
                                    <label for="password" class="label"><span class="label-text">Password</span></label>
                                    <input type="password" class="input input-bordered w-full" id="password" name="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                                </div>
                            </div>
                        </div>

                        <!-- USB-specific fields -->
                        <div id="usbFields" class="hidden">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="form-control">
                                    <label for="deviceIndex" class="label">
                                        <span class="label-text">USB Camera Device <span class="text-error">*</span></span>
                                    </label>
                                    <select class="select select-bordered w-full" id="deviceIndex" name="deviceIndex">
                                        <option value="">Select USB Camera...</option>
                                        <option value="0">Camera 0</option>
                                        <option value="1">Camera 1</option>
                                        <option value="2">Camera 2</option>
                                        <option value="3">Camera 3</option>
                                    </select>
                                </div>
                                <div class="form-control">
                                    <button type="button" class="btn btn-sm mt-8" id="refreshUsbDevices">
                                        ðŸ”„ Detect USB Cameras
                                    </button>
                                </div>
                            </div>
                            <div id="usbDeviceInfo" class="alert alert-info mt-2 hidden">
                                <div class="text-sm"></div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="form-control">
                                <label for="latitude" class="label">
                                    <span class="label-text">Latitude</span>
                                </label>
                                <input type="number" step="any" class="input input-bordered w-full" id="latitude" name="latitude" 
                                       placeholder="e.g., 40.7589" min="-90" max="90">
                            </div>
                            <div class="form-control">
                                <label for="longitude" class="label">
                                    <span class="label-text">Longitude</span>
                                </label>
                                <input type="number" step="any" class="input input-bordered w-full" id="longitude" name="longitude" 
                                       placeholder="e.g., -73.9851" min="-180" max="180">
                            </div>
                        </div>


                        <!-- Connection Test Status -->
                        <div id="connectionStatus" class="hidden" style="margin-top: 1.5rem;" role="alert"></div>
                    </form>
                    
                    <div class="modal-action">
                        <button type="button" class="btn" id="testConnection">
                            Test Connection
                        </button>
                        <button type="button" class="btn btn-neutral" id="addCameraBtn">
                            Add Svl Device
                        </button>
                    </div>
        </div>
    </dialog>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const testConnectionBtn = document.getElementById('testConnection');
        const addCameraBtn = document.getElementById('addCameraBtn');
        const connectionStatus = document.getElementById('connectionStatus');
        const addCameraForm = document.getElementById('addCameraForm');
        const cameraTypeSelect = document.getElementById('cameraType');
        const rtspFields = document.getElementById('rtspFields');
        const usbFields = document.getElementById('usbFields');
        const deviceIndexSelect = document.getElementById('deviceIndex');
        const refreshUsbBtn = document.getElementById('refreshUsbDevices');
        const usbDeviceInfo = document.getElementById('usbDeviceInfo');

        // Handle camera type switching
        cameraTypeSelect.addEventListener('change', function() {
            const isUsb = this.value === 'usb';

            if (isUsb) {
                // Show USB fields, hide RTSP fields
                rtspFields.classList.add('hidden');
                usbFields.classList.remove('hidden');

                // Make RTSP fields optional
                document.getElementById('rtspUrl').removeAttribute('required');
                document.getElementById('deviceIndex').setAttribute('required', 'required');

                // Load USB devices
                loadUsbDevices();
            } else {
                // Show RTSP fields, hide USB fields
                rtspFields.classList.remove('hidden');
                usbFields.classList.add('hidden');

                // Make RTSP fields required
                document.getElementById('rtspUrl').setAttribute('required', 'required');
                document.getElementById('deviceIndex').removeAttribute('required');
            }

            // Clear connection status
            connectionStatus.classList.add('hidden');
        });

        // USB device detection
        async function loadUsbDevices() {
            try {
                const response = await fetch('/api/usb-devices');
                const result = await response.json();

                if (result.success) {
                    deviceIndexSelect.innerHTML = '<option value="">Select USB Camera...</option>';

                    if (result.devices.length === 0) {
                        usbDeviceInfo.classList.remove('hidden');
                        usbDeviceInfo.querySelector('div').innerHTML = 'No USB cameras detected. Please connect a USB camera and refresh.';
                        usbDeviceInfo.className = 'alert alert-warning mt-2';
                    } else {
                        result.devices.forEach(device => {
                            const option = document.createElement('option');
                            option.value = device.index;
                            option.textContent = `${device.name} (${device.resolution})`;
                            if (device.in_use) {
                                option.textContent += ' [IN USE]';
                                option.disabled = true;
                            }
                            deviceIndexSelect.appendChild(option);
                        });

                        usbDeviceInfo.classList.remove('hidden');
                        usbDeviceInfo.querySelector('div').innerHTML = `Found ${result.devices.length} USB camera(s)`;
                        usbDeviceInfo.className = 'alert alert-info mt-2';
                    }
                }
            } catch (error) {
                console.error('Error loading USB devices:', error);
            }
        }

        // Refresh USB devices button
        refreshUsbBtn.addEventListener('click', loadUsbDevices);
        
        // Test Connection functionality
        testConnectionBtn.addEventListener('click', async function() {
            const cameraType = document.getElementById('cameraType').value;
            let testData = { camera_type: cameraType };

            if (cameraType === 'usb') {
                const deviceIndex = document.getElementById('deviceIndex').value;
                if (!deviceIndex) {
                    alert('Please select a USB camera device.');
                    return;
                }
                testData.device_index = parseInt(deviceIndex);
            } else {
                const rtspUrl = document.getElementById('rtspUrl').value.trim();
                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value.trim();

                if (!rtspUrl) {
                    alert('Please enter an RTSP URL first.');
                    return;
                }
                testData.rtsp_url = rtspUrl;
                testData.username = username;
                testData.password = password;
            }

            const connectionMessage = cameraType === 'usb'
                ? `Testing USB camera device ${testData.device_index}...`
                : `Testing connection to ${testData.rtsp_url}...`;

            connectionStatus.className = 'alert alert-info';
            connectionStatus.innerHTML = `
                <div class="flex items-center">
                    <div class="loading loading-spinner loading-sm mr-2" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                    ${connectionMessage}
                </div>
            `;
            connectionStatus.classList.remove('hidden');

            try {
                const response = await fetch('/api/cameras/test-connection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testData)
                });

                const result = await response.json();
                
                if (result.success) {
                    connectionStatus.className = 'alert alert-success';
                    connectionStatus.innerHTML = `
                        <div class="flex items-center">
                            <span class="mr-2">âœ…</span>
                            ${result.message}
                            ${result.frame_shape ? `<br><small>Frame resolution: ${result.frame_shape[1]}x${result.frame_shape[0]}</small>` : ''}
                        </div>
                    `;
                } else {
                    connectionStatus.className = 'alert alert-error';
                    connectionStatus.innerHTML = `
                        <div class="flex items-center">
                            ${result.error}
                        </div>
                    `;
                }
            } catch (error) {
                connectionStatus.className = 'alert alert-error';
                connectionStatus.innerHTML = `
                    <div class="flex items-center">
                        Network error: ${error.message}
                    </div>
                `;
            }
        });

        // Add Camera functionality
        addCameraBtn.addEventListener('click', async function() {
            const formData = new FormData(addCameraForm);
            const cameraType = formData.get('cameraType');
            const latitude = formData.get('latitude')?.trim();
            const longitude = formData.get('longitude')?.trim();

            const cameraData = {
                name: formData.get('cameraName').trim() || null,
                unique_id: formData.get('uniqueId').trim(),
                camera_type: cameraType,
                latitude: latitude && latitude !== '' ? parseFloat(latitude) : null,
                longitude: longitude && longitude !== '' ? parseFloat(longitude) : null,
                auto_start: true
            };

            // Add type-specific fields
            if (cameraType === 'usb') {
                const deviceIndex = formData.get('deviceIndex');
                if (!deviceIndex) {
                    alert('Please select a USB camera device.');
                    return;
                }
                cameraData.device_index = parseInt(deviceIndex);
            } else {
                cameraData.rtsp_url = formData.get('rtspUrl').trim();
                cameraData.username = formData.get('username').trim();
                cameraData.password = formData.get('password').trim();

                if (!cameraData.rtsp_url) {
                    alert('Please enter an RTSP URL.');
                    return;
                }
            }

            if (!cameraData.unique_id) {
                alert('Please enter a Unique ID.');
                return;
            }

            // Validate unique_id format
            if (!/^[a-zA-Z0-9_-]+$/.test(cameraData.unique_id)) {
                alert('Unique ID can only contain letters, numbers, underscores, and hyphens.');
                return;
            }

            try {
                const response = await fetch('/api/cameras', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(cameraData)
                });

                const result = await response.json();
                
                if (result.success) {
                    // Clear form and close modal
                    addCameraForm.reset();
                    connectionStatus.classList.add('hidden');
                    
                    document.getElementById('addCameraModal').close();
                    
                    // Refresh page to show new camera (visual feedback is sufficient)
                    setTimeout(() => location.reload(), 500);
                } else {
                    showNotification(`Error: ${result.error}`, 'danger');
                }
            } catch (error) {
                showNotification(`Network error: ${error.message}`, 'danger');
            }
        });

        function showNotification(message, type) {
            // Map Bootstrap types to DaisyUI types
            const typeMap = {
                'success': 'alert-success',
                'danger': 'alert-error',
                'warning': 'alert-warning',
                'info': 'alert-info'
            };
            
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${typeMap[type] || 'alert-info'} fixed top-4 left-1/2 transform -translate-x-1/2 z-50 max-w-md shadow-lg`;
            alertDiv.innerHTML = `
                <div class="flex items-center justify-between">
                    <span>${message}</span>
                    <button type="button" class="btn btn-sm btn-circle btn-ghost" onclick="this.parentElement.parentElement.remove()">âœ•</button>
                </div>
            `;
            
            document.body.appendChild(alertDiv);
            
            // Auto remove after 4 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 4000);
        }
    });
    </script>

</body>
</html>