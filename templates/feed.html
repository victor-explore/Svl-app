{% extends "base.html" %}

{% block title %}Enhanced Camera Feed - Svl App{% endblock %}

{% block content %}
<!-- Add Camera Button -->
<div class="mb-4">
    <button class="btn btn-neutral" onclick="addCameraModal.showModal()">
        Add Camera
    </button>
</div>

<!-- Camera Grid -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-5 pb-4" id="cameraGrid">
    {% for camera in cameras %}
    <div>
        <div class="card bg-base-100 shadow-sm border border-base-300" data-camera-id="{{ camera.id }}">
            <!-- Header -->
            <div class="flex justify-between items-center p-4 border-b border-base-300">
                <span class="font-medium">{{ camera.name }}</span>
                <button class="btn btn-ghost btn-sm delete-btn" 
                        data-camera-id="{{ camera.id }}"
                        title="Delete Camera">
                    ‚úï
                </button>
            </div>
            
            <!-- Video Area -->
            <figure class="h-48 w-full {% if camera.status == 'online' %}bg-base-300{% elif camera.status == 'offline' %}bg-base-100{% else %}bg-base-100{% endif %}">
                <div class="h-full w-full relative">
                    {% if camera.status == 'online' or camera.status == 'recording' %}
                        <img src="/api/cameras/{{ camera.id }}/stream" 
                             class="w-full h-full object-cover"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                             alt="Live stream from {{ camera.name }}">
                        <div class="hidden items-center justify-center h-full w-full text-base-content">
                            <div class="text-center">
                                <div class="text-4xl mb-2">üì∫</div>
                                <div class="text-sm">Stream Error</div>
                            </div>
                        </div>
                        
                    {% elif camera.status == 'offline' %}
                        <div class="flex items-center justify-center h-full w-full text-base-content">
                            <div class="text-center">
                                <div class="text-4xl mb-2">üì∫</div>
                                <div class="text-sm">Offline</div>
                            </div>
                        </div>
                    {% else %}
                        <div class="flex items-center justify-center h-full w-full text-base-content">
                            <div class="text-center">
                                <div class="text-4xl mb-2">‚óè‚óè‚óè</div>
                                <div class="text-sm">Connecting</div>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </figure>
        </div>
    </div>
    {% endfor %}

</div>

<!-- Enhanced Stats Bottom Aligned -->
<div class="fixed bottom-0 left-0 w-full bg-base-200 border-t border-base-300 shadow-lg py-2 z-[1000]">
    <div class="text-center">
        <div class="mb-1">
            üìä <strong>Stats:</strong> 
            <span class="badge badge-success mr-1">{{ stats.online }} Online</span>
            <span class="badge badge-error mr-1">{{ stats.offline }} Offline</span>
            <span class="badge badge-warning mr-1">{{ stats.connecting }} Connecting</span>
        </div>
        <div class="text-base-content opacity-60">
            üïê <strong>Last Update:</strong> <span id="lastUpdate">just now</span> | 
            <strong>Total Frames:</strong> <span id="totalFrames">--</span>
        </div>
    </div>
</div>

<!-- Add Camera Modal -->
<dialog id="addCameraModal" class="modal">
    <div class="modal-box w-11/12 max-w-5xl">
            <div class="bg-success text-white p-4 rounded-t">
                <h1 class="text-lg font-bold" id="addCameraModalLabel">‚ûï Add New Camera</h1>
                <button type="button" class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2" onclick="addCameraModal.close()" aria-label="Close">‚úï</button>
            </div>
            <div class="p-4">
                <form id="addCameraForm">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="form-control">
                            <label for="cameraName" class="label"><span class="label-text">Camera Name <span class="text-error">*</span></span></label>
                            <input type="text" class="input input-bordered w-full" id="cameraName" name="cameraName" placeholder="e.g., Front Door, Backyard" required>
                            <div class="label"><span class="label-text-alt">Enter a descriptive name for your camera</span></div>
                        </div>
                        <div class="form-control">
                            <label for="rtspUrl" class="label"><span class="label-text">RTSP URL <span class="text-error">*</span></span></label>
                            <input type="url" class="input input-bordered w-full" id="rtspUrl" name="rtspUrl" placeholder="rtsp://192.168.1.100:554/stream" required>
                            <div class="label"><span class="label-text-alt">Complete RTSP stream URL</span></div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="form-control">
                            <label for="username" class="label"><span class="label-text">Username</span></label>
                            <input type="text" class="input input-bordered w-full" id="username" name="username" placeholder="admin">
                            <div class="label"><span class="label-text-alt">Camera authentication username (optional)</span></div>
                        </div>
                        <div class="form-control">
                            <label for="password" class="label"><span class="label-text">Password</span></label>
                            <input type="password" class="input input-bordered w-full" id="password" name="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                            <div class="label"><span class="label-text-alt">Camera authentication password (optional)</span></div>
                        </div>
                    </div>


                    <!-- Connection Test Status -->
                    <div id="connectionStatus" class="alert alert-info hidden" role="alert">
                        <div class="flex items-center">
                            <div class="loading loading-spinner loading-sm mr-2" role="status">
                                <span class="sr-only">Loading...</span>
                            </div>
                            Testing connection...
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-action justify-center">
                <button type="button" class="btn btn-info shadow-sm" id="testConnection">
                    üîó Test Connection
                </button>
                <button type="button" class="btn btn-success shadow-sm" id="addCameraBtn">
                    ‚ûï Add Camera
                </button>
            </div>
    </div>
</dialog>


<script>
document.addEventListener('DOMContentLoaded', function() {
    const testConnectionBtn = document.getElementById('testConnection');
    const addCameraBtn = document.getElementById('addCameraBtn');
    const connectionStatus = document.getElementById('connectionStatus');
    const addCameraForm = document.getElementById('addCameraForm');
    const cameraGrid = document.getElementById('cameraGrid');
    
    let updateInterval;

    // Initialize real-time updates
    startRealTimeUpdates();

    // Test Connection functionality with enhanced API
    testConnectionBtn.addEventListener('click', async function() {
        const rtspUrl = document.getElementById('rtspUrl').value.trim();
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value.trim();

        if (!rtspUrl) {
            alert('Please enter an RTSP URL first.');
            return;
        }

        connectionStatus.className = 'alert alert-info';
        connectionStatus.innerHTML = `
            <div class="flex items-center">
                <div class="loading loading-spinner loading-sm mr-2" role="status">
                    <span class="sr-only">Loading...</span>
                </div>
                Testing connection to ${rtspUrl}...
            </div>
        `;
        connectionStatus.classList.remove('hidden');

        try {
            const response = await fetch('/api/cameras/test-connection', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    rtsp_url: rtspUrl,
                    username: username,
                    password: password
                })
            });

            const result = await response.json();
            
            if (result.success) {
                connectionStatus.className = 'alert alert-success';
                connectionStatus.innerHTML = `
                    <div class="flex items-center">
                        <span class="mr-2">‚úÖ</span>
                        ${result.message}
                        ${result.frame_shape ? `<br><small>Frame resolution: ${result.frame_shape[1]}x${result.frame_shape[0]}</small>` : ''}
                    </div>
                `;
            } else {
                connectionStatus.className = 'alert alert-error';
                connectionStatus.innerHTML = `
                    <div class="flex items-center">
                        <span class="mr-2">‚ùå</span>
                        ${result.error}
                    </div>
                `;
            }
        } catch (error) {
            connectionStatus.className = 'alert alert-error';
            connectionStatus.innerHTML = `
                <div class="flex items-center">
                    <span class="mr-2">‚ùå</span>
                    Network error: ${error.message}
                </div>
            `;
        }
    });

    // Enhanced Add Camera functionality
    addCameraBtn.addEventListener('click', async function() {
        const formData = new FormData(addCameraForm);
        const cameraData = {
            name: formData.get('cameraName').trim(),
            rtsp_url: formData.get('rtspUrl').trim(),
            username: formData.get('username').trim(),
            password: formData.get('password').trim(),
            auto_start: true,
            record_footage: false
        };

        if (!cameraData.name || !cameraData.rtsp_url) {
            alert('Please fill in all required fields (Camera Name and RTSP URL).');
            return;
        }

        try {
            const response = await fetch('/api/cameras', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(cameraData)
            });

            const result = await response.json();
            
            if (result.success) {
                // Clear form and close modal
                addCameraForm.reset();
                connectionStatus.classList.add('hidden');
                
                document.getElementById('addCameraModal').close();

                showNotification('Camera added successfully! Refreshing page...', 'success');
                
                // Refresh page to show new camera
                setTimeout(() => location.reload(), 1500);
            } else {
                showNotification(`Error: ${result.error}`, 'danger');
            }
        } catch (error) {
            showNotification(`Network error: ${error.message}`, 'danger');
        }
    });



    // Delete button functionality
    document.addEventListener('click', async function(e) {
        if (e.target.classList.contains('delete-btn')) {
            const cameraId = e.target.getAttribute('data-camera-id');
            
            if (confirm('Are you sure you want to delete this camera?')) {
                try {
                    const response = await fetch(`/api/cameras/${cameraId}`, {
                        method: 'DELETE'
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        showNotification('Camera deleted successfully!', 'success');
                        // Remove camera card
                        const cameraCard = document.querySelector(`[data-camera-id="${cameraId}"]`).closest('div');
                        cameraCard.remove();
                        updateRealTimeStats();
                    } else {
                        showNotification(`Error: ${result.error}`, 'danger');
                    }
                } catch (error) {
                    showNotification(`Network error: ${error.message}`, 'danger');
                }
            }
        }
    });



    function startRealTimeUpdates() {
        updateRealTimeStats();
        updateInterval = setInterval(updateRealTimeStats, 5000); // Update every 5 seconds (reduced from 3s for better performance)
    }

    async function updateRealTimeStats() {
        try {
            const response = await fetch('/api/system/status');
            const result = await response.json();
            
            if (result.success) {
                // Update bottom stats
                const systemStatus = result.system_status;
                const bottomStats = document.querySelector('.fixed .text-center div:first-child');
                bottomStats.innerHTML = `
                    üìä <strong>Stats:</strong> 
                    <span class="badge badge-success shadow-sm mr-1">${systemStatus.online_cameras} Online</span>
                    <span class="badge badge-error shadow-sm mr-1">${systemStatus.offline_cameras} Offline</span>
                    <span class="badge badge-warning shadow-sm mr-1">${systemStatus.total_cameras - systemStatus.online_cameras - systemStatus.offline_cameras} Connecting</span>
                `;
                
                // Update total frames
                document.getElementById('totalFrames').textContent = systemStatus.total_frames_captured.toLocaleString();
                
                // Camera statuses updated via bottom stats only
                
                // Update last update time
                document.getElementById('lastUpdate').textContent = 'just now';
            }
        } catch (error) {
            console.error('Error updating real-time stats:', error);
        }
    }

    function showNotification(message, type) {
        // Map Bootstrap types to DaisyUI types
        const typeMap = {
            'success': 'alert-success',
            'danger': 'alert-error',
            'warning': 'alert-warning',
            'info': 'alert-info'
        };
        
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert ${typeMap[type] || 'alert-info'} fixed top-4 left-1/2 transform -translate-x-1/2 z-[9999] max-w-md shadow-lg`;
        alertDiv.innerHTML = `
            <div class="flex items-center justify-between">
                <span>${message}</span>
                <button type="button" class="btn btn-sm btn-circle btn-ghost" onclick="this.parentElement.parentElement.remove()">‚úï</button>
            </div>
        `;
        
        document.body.appendChild(alertDiv);
        
        // Auto remove after 4 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 4000);
    }

    // Cleanup interval on page unload
    window.addEventListener('beforeunload', function() {
        if (updateInterval) {
            clearInterval(updateInterval);
        }
    });
});
</script>
{% endblock %}