{% extends "base.html" %}

{% block title %}Enhanced Camera Feed - Svl App{% endblock %}

{% block content %}
<!-- Camera Grid -->
<div class="row g-4 mb-5 pb-4" id="cameraGrid">
    {% for camera in cameras %}
    <div class="col-lg-4 col-md-6">
        <div class="card" data-camera-id="{{ camera.id }}">
            <div class="card-header 
                {% if camera.status == 'online' %}bg-success
                {% elif camera.status == 'offline' %}bg-danger
                {% elif camera.status == 'recording' %}bg-info
                {% else %}bg-warning
                {% endif %} text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">{{ camera.name }}</h5>
                <div class="d-flex gap-2">
                    <!-- Connection Status Badge -->
                    <span class="badge bg-light 
                        {% if camera.status == 'online' %}text-success">üü¢ ONLINE
                        {% elif camera.status == 'offline' %}text-danger">üî¥ OFFLINE
                        {% elif camera.status == 'recording' %}text-info">üîµ RECORDING
                        {% else %}text-warning">üü° CONNECTING
                        {% endif %}</span>
                    
                    <!-- Recording Status Badge -->
                    {% if camera.get('recording_status') == 'recording' %}
                    <span class="badge bg-danger">üî¥ REC</span>
                    {% endif %}
                </div>
            </div>
            <div class="card-body p-0">
                <div class="position-relative" style="height: 200px; background: {% if camera.status == 'online' %}#000{% elif camera.status == 'offline' %}#333{% else %}#666{% endif %};">
                    {% if camera.status == 'online' or camera.status == 'recording' %}
                        <img src="/api/cameras/{{ camera.id }}/stream" 
                             style="width: 100%; height: 200px; object-fit: cover;"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                             alt="Live stream from {{ camera.name }}">
                        <div class="d-none align-items-center justify-content-center h-100 text-white position-absolute top-0 start-0 w-100">
                            <div class="text-center">
                                <div class="mb-2" style="font-size: 2rem;">üì∫</div>
                                <div>[STREAM ERROR]</div>
                                <div class="mt-2">‚ùå FAILED</div>
                            </div>
                        </div>
                        
                        <!-- Recording Indicator Overlay -->
                        {% if camera.get('recording_status') == 'recording' %}
                        <div class="position-absolute top-0 start-0 m-2">
                            <span class="badge bg-danger d-flex align-items-center">
                                <span class="recording-dot me-1"></span>
                                REC
                            </span>
                        </div>
                        {% endif %}
                        
                    {% elif camera.status == 'offline' %}
                        <div class="d-flex align-items-center justify-content-center h-100 text-white">
                            <div class="text-center">
                                <div class="mb-2" style="font-size: 2rem;">üì∫</div>
                                <div>[NO SIGNAL]</div>
                                <div class="mt-2">üî¥ OFFLINE</div>
                            </div>
                        </div>
                    {% else %}
                        <div class="d-flex align-items-center justify-content-center h-100 text-white">
                            <div class="text-center">
                                <div class="mb-2">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                                <div>[CONNECTING...]</div>
                                <div class="mt-2">üü° CONNECTING</div>
                            </div>
                        </div>
                    {% endif %}
                </div>
                
                <!-- Enhanced Camera Controls -->
                <div class="p-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <small class="text-muted">
                            <strong>ID:</strong> {{ camera.id }} | 
                            <strong>FPS:</strong> <span class="camera-fps" data-camera-id="{{ camera.id }}">--</span>
                        </small>
                        <div class="btn-group btn-group-sm" role="group">
                            <!-- Recording Toggle Button -->
                            {% if camera.status == 'online' or camera.get('recording_status') == 'recording' %}
                            <button class="btn {% if camera.get('recording_status') == 'recording' %}btn-danger{% else %}btn-outline-danger{% endif %} record-toggle-btn" 
                                    data-camera-id="{{ camera.id }}"
                                    title="{% if camera.get('recording_status') == 'recording' %}Stop Recording{% else %}Start Recording{% endif %}">
                                {% if camera.get('recording_status') == 'recording' %}
                                    ‚èπÔ∏è
                                {% else %}
                                    ‚è∫Ô∏è
                                {% endif %}
                            </button>
                            {% endif %}
                            
                            <!-- Camera Status Button -->
                            <button class="btn btn-outline-info btn-sm status-btn" 
                                    data-camera-id="{{ camera.id }}"
                                    title="View Detailed Status">
                                ‚ÑπÔ∏è
                            </button>
                            
                            <!-- Delete Button -->
                            <button class="btn btn-outline-danger btn-sm delete-btn" 
                                    data-camera-id="{{ camera.id }}"
                                    title="Delete Camera">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                    
                    <!-- Camera Stats -->
                    <div class="camera-stats" data-camera-id="{{ camera.id }}">
                        <small class="text-muted d-block">
                            <strong>Frames:</strong> <span class="frames-captured">--</span> | 
                            <strong>Status:</strong> <span class="connection-status">{{ camera.status }}</span>
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}

    <!-- Add New Camera Card -->
    <div class="col-lg-4 col-md-6">
        <div class="card border-2 border-dashed">
            <div class="card-body text-center d-flex align-items-center justify-content-center" style="height: 300px;">
                <div>
                    <div class="mb-3" style="font-size: 3rem; color: #6c757d;">‚ûï</div>
                    <h5 class="text-muted mb-2">Add New Camera</h5>
                    <p class="text-muted small mb-3">Click to add a new RTSP camera feed</p>
                    <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addCameraModal">
                        Add Camera
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Stats Bottom Aligned -->
<div class="position-fixed bottom-0 start-0 w-100 bg-light border-top py-2" style="z-index: 1000;">
    <div class="text-center">
        <div class="mb-1">
            üìä <strong>Stats:</strong> 
            <span class="badge bg-success me-1">{{ stats.online }} Online</span>
            <span class="badge bg-danger me-1">{{ stats.offline }} Offline</span>
            <span class="badge bg-warning me-1">{{ stats.connecting }} Connecting</span>
            <span class="badge bg-info me-1">{{ stats.get('recording', 0) }} Recording</span>
        </div>
        <div class="text-muted">
            üïê <strong>Last Update:</strong> <span id="lastUpdate">just now</span> | 
            <strong>Total Frames:</strong> <span id="totalFrames">--</span>
        </div>
    </div>
</div>

<!-- Add Camera Modal -->
<div class="modal fade" id="addCameraModal" tabindex="-1" aria-labelledby="addCameraModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h1 class="modal-title fs-5" id="addCameraModalLabel">‚ûï Add New Camera</h1>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addCameraForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="cameraName" class="form-label">Camera Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="cameraName" name="cameraName" placeholder="e.g., Front Door, Backyard" required>
                            <div class="form-text">Enter a descriptive name for your camera</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="rtspUrl" class="form-label">RTSP URL <span class="text-danger">*</span></label>
                            <input type="url" class="form-control" id="rtspUrl" name="rtspUrl" placeholder="rtsp://192.168.1.100:554/stream" required>
                            <div class="form-text">Complete RTSP stream URL</div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="username" class="form-label">Username</label>
                            <input type="text" class="form-control" id="username" name="username" placeholder="admin">
                            <div class="form-text">Camera authentication username (optional)</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="password" class="form-label">Password</label>
                            <input type="password" class="form-control" id="password" name="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                            <div class="form-text">Camera authentication password (optional)</div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="autoStart" name="autoStart" checked>
                                <label class="form-check-label" for="autoStart">
                                    ‚òê Auto-start stream
                                </label>
                                <div class="form-text">Automatically start streaming when camera is added</div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="recordFootage" name="recordFootage">
                                <label class="form-check-label" for="recordFootage">
                                    ‚òê Record footage
                                </label>
                                <div class="form-text">Enable automatic recording of camera feed</div>
                            </div>
                        </div>
                    </div>

                    <!-- Connection Test Status -->
                    <div id="connectionStatus" class="alert alert-info d-none" role="alert">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm me-2" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            Testing connection...
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-info" id="testConnection">
                    üîó Test Connection
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    Cancel
                </button>
                <button type="button" class="btn btn-success" id="addCameraBtn">
                    ‚ûï Add Camera
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Detailed Status Modal -->
<div class="modal fade" id="statusModal" tabindex="-1" aria-labelledby="statusModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h1 class="modal-title fs-5" id="statusModalLabel">üìä Camera Status Details</h1>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="statusContent">Loading...</div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Recording Dot CSS Animation -->
<style>
.recording-dot {
    width: 8px;
    height: 8px;
    background-color: #ff0000;
    border-radius: 50%;
    animation: recording-blink 1s infinite;
}

@keyframes recording-blink {
    0%, 50% { opacity: 1; }
    51%, 100% { opacity: 0.3; }
}

.camera-stats {
    font-size: 0.8rem;
}

.btn-group-sm .btn {
    padding: 0.25rem 0.4rem;
    font-size: 0.75rem;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const testConnectionBtn = document.getElementById('testConnection');
    const addCameraBtn = document.getElementById('addCameraBtn');
    const connectionStatus = document.getElementById('connectionStatus');
    const addCameraForm = document.getElementById('addCameraForm');
    const cameraGrid = document.getElementById('cameraGrid');
    
    let updateInterval;
    let fpsHistory = {}; // Store FPS history for smoothing

    // FPS smoothing function for better user experience
    function smoothFPS(cameraId, currentFPS) {
        if (!fpsHistory[cameraId]) {
            fpsHistory[cameraId] = [];
        }
        
        fpsHistory[cameraId].push(currentFPS);
        if (fpsHistory[cameraId].length > 5) {
            fpsHistory[cameraId].shift(); // Keep last 5 readings
        }
        
        // Return moving average
        const avg = fpsHistory[cameraId].reduce((a, b) => a + b, 0) / fpsHistory[cameraId].length;
        return Math.round(avg * 10) / 10; // Round to 1 decimal
    }

    // Initialize real-time updates
    startRealTimeUpdates();

    // Test Connection functionality with enhanced API
    testConnectionBtn.addEventListener('click', async function() {
        const rtspUrl = document.getElementById('rtspUrl').value.trim();
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value.trim();

        if (!rtspUrl) {
            alert('Please enter an RTSP URL first.');
            return;
        }

        connectionStatus.className = 'alert alert-info';
        connectionStatus.innerHTML = `
            <div class="d-flex align-items-center">
                <div class="spinner-border spinner-border-sm me-2" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                Testing connection to ${rtspUrl}...
            </div>
        `;
        connectionStatus.classList.remove('d-none');

        try {
            const response = await fetch('/api/cameras/test-connection', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    rtsp_url: rtspUrl,
                    username: username,
                    password: password
                })
            });

            const result = await response.json();
            
            if (result.success) {
                connectionStatus.className = 'alert alert-success';
                connectionStatus.innerHTML = `
                    <div class="d-flex align-items-center">
                        <span class="me-2">‚úÖ</span>
                        ${result.message}
                        ${result.frame_shape ? `<br><small>Frame resolution: ${result.frame_shape[1]}x${result.frame_shape[0]}</small>` : ''}
                    </div>
                `;
            } else {
                connectionStatus.className = 'alert alert-danger';
                connectionStatus.innerHTML = `
                    <div class="d-flex align-items-center">
                        <span class="me-2">‚ùå</span>
                        ${result.error}
                    </div>
                `;
            }
        } catch (error) {
            connectionStatus.className = 'alert alert-danger';
            connectionStatus.innerHTML = `
                <div class="d-flex align-items-center">
                    <span class="me-2">‚ùå</span>
                    Network error: ${error.message}
                </div>
            `;
        }
    });

    // Enhanced Add Camera functionality
    addCameraBtn.addEventListener('click', async function() {
        const formData = new FormData(addCameraForm);
        const cameraData = {
            name: formData.get('cameraName').trim(),
            rtsp_url: formData.get('rtspUrl').trim(),
            username: formData.get('username').trim(),
            password: formData.get('password').trim(),
            auto_start: formData.get('autoStart') === 'on',
            record_footage: formData.get('recordFootage') === 'on'
        };

        if (!cameraData.name || !cameraData.rtsp_url) {
            alert('Please fill in all required fields (Camera Name and RTSP URL).');
            return;
        }

        try {
            const response = await fetch('/api/cameras', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(cameraData)
            });

            const result = await response.json();
            
            if (result.success) {
                // Clear form and close modal
                addCameraForm.reset();
                document.getElementById('autoStart').checked = true;
                connectionStatus.classList.add('d-none');
                
                const modal = bootstrap.Modal.getInstance(document.getElementById('addCameraModal'));
                modal.hide();

                showNotification('Camera added successfully! Refreshing page...', 'success');
                
                // Refresh page to show new camera
                setTimeout(() => location.reload(), 1500);
            } else {
                showNotification(`Error: ${result.error}`, 'danger');
            }
        } catch (error) {
            showNotification(`Network error: ${error.message}`, 'danger');
        }
    });

    // Recording toggle functionality
    document.addEventListener('click', async function(e) {
        if (e.target.classList.contains('record-toggle-btn')) {
            const cameraId = e.target.getAttribute('data-camera-id');
            const isRecording = e.target.classList.contains('btn-danger');
            
            try {
                const endpoint = `/api/cameras/${cameraId}/recording/toggle`;
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    showNotification(result.message, 'success');
                    // Update button state
                    updateRecordingButton(e.target, result.recording_status === 'recording');
                } else {
                    showNotification(`Error: ${result.error}`, 'danger');
                }
            } catch (error) {
                showNotification(`Network error: ${error.message}`, 'danger');
            }
        }
    });

    // Status button functionality
    document.addEventListener('click', async function(e) {
        if (e.target.classList.contains('status-btn')) {
            const cameraId = e.target.getAttribute('data-camera-id');
            
            try {
                const response = await fetch(`/api/cameras/${cameraId}/status`);
                const result = await response.json();
                
                if (result.success) {
                    showStatusModal(result);
                } else {
                    showNotification(`Error: ${result.error}`, 'danger');
                }
            } catch (error) {
                showNotification(`Network error: ${error.message}`, 'danger');
            }
        }
    });

    // Delete button functionality
    document.addEventListener('click', async function(e) {
        if (e.target.classList.contains('delete-btn')) {
            const cameraId = e.target.getAttribute('data-camera-id');
            
            if (confirm('Are you sure you want to delete this camera?')) {
                try {
                    const response = await fetch(`/api/cameras/${cameraId}`, {
                        method: 'DELETE'
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        showNotification('Camera deleted successfully!', 'success');
                        // Remove camera card
                        const cameraCard = document.querySelector(`[data-camera-id="${cameraId}"]`).closest('.col-lg-4');
                        cameraCard.remove();
                        updateRealTimeStats();
                    } else {
                        showNotification(`Error: ${result.error}`, 'danger');
                    }
                } catch (error) {
                    showNotification(`Network error: ${error.message}`, 'danger');
                }
            }
        }
    });

    function updateRecordingButton(button, isRecording) {
        if (isRecording) {
            button.className = 'btn btn-danger record-toggle-btn';
            button.innerHTML = '‚èπÔ∏è';
            button.title = 'Stop Recording';
        } else {
            button.className = 'btn btn-outline-danger record-toggle-btn';
            button.innerHTML = '‚è∫Ô∏è';
            button.title = 'Start Recording';
        }
    }

    function showStatusModal(statusData) {
        const modal = new bootstrap.Modal(document.getElementById('statusModal'));
        const content = document.getElementById('statusContent');
        
        const status = statusData.status;
        const recording = status.recording;
        
        content.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <h6>Connection Status</h6>
                    <ul class="list-unstyled">
                        <li><strong>Status:</strong> ${status.status}</li>
                        <li><strong>FPS:</strong> ${status.fps}</li>
                        <li><strong>Frames Captured:</strong> ${status.frames_captured}</li>
                        <li><strong>Frames Dropped:</strong> ${status.frames_dropped}</li>
                        <li><strong>Uptime:</strong> ${status.uptime_seconds}s</li>
                        <li><strong>Connection Attempts:</strong> ${status.connection_attempts}</li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <h6>Recording Status</h6>
                    <ul class="list-unstyled">
                        <li><strong>Recording:</strong> ${recording.is_recording ? 'Yes' : 'No'}</li>
                        <li><strong>Duration:</strong> ${recording.recording_duration}s</li>
                        <li><strong>Output Dir:</strong> ${recording.output_directory}</li>
                        <li><strong>Start Time:</strong> ${recording.recording_start_time || 'N/A'}</li>
                    </ul>
                </div>
            </div>
            
            ${status.last_error ? `
                <div class="alert alert-warning mt-3">
                    <strong>Last Error:</strong> ${status.last_error}
                </div>
            ` : ''}
            
            ${recording.last_error ? `
                <div class="alert alert-danger mt-3">
                    <strong>Recording Error:</strong> ${recording.last_error}
                </div>
            ` : ''}
        `;
        
        document.getElementById('statusModalLabel').textContent = `üìä ${statusData.camera_name} - Status Details`;
        modal.show();
    }

    function startRealTimeUpdates() {
        updateRealTimeStats();
        updateInterval = setInterval(updateRealTimeStats, 5000); // Update every 5 seconds (reduced from 3s for better performance)
    }

    async function updateRealTimeStats() {
        try {
            const response = await fetch('/api/system/status');
            const result = await response.json();
            
            if (result.success) {
                // Update bottom stats
                const systemStatus = result.system_status;
                const bottomStats = document.querySelector('.position-fixed .text-center div:first-child');
                bottomStats.innerHTML = `
                    üìä <strong>Stats:</strong> 
                    <span class="badge bg-success me-1">${systemStatus.online_cameras} Online</span>
                    <span class="badge bg-danger me-1">${systemStatus.offline_cameras} Offline</span>
                    <span class="badge bg-warning me-1">${systemStatus.total_cameras - systemStatus.online_cameras - systemStatus.offline_cameras} Connecting</span>
                    <span class="badge bg-info me-1">${systemStatus.recording_cameras} Recording</span>
                `;
                
                // Update total frames
                document.getElementById('totalFrames').textContent = systemStatus.total_frames_captured.toLocaleString();
                
                // Update individual camera stats with FPS smoothing
                const cameraStatuses = result.camera_statuses;
                for (const [cameraId, status] of Object.entries(cameraStatuses)) {
                    if (status) {
                        const fpsElement = document.querySelector(`.camera-fps[data-camera-id="${cameraId}"]`);
                        const framesElement = document.querySelector(`[data-camera-id="${cameraId}"] .frames-captured`);
                        const connectionElement = document.querySelector(`[data-camera-id="${cameraId}"] .connection-status`);
                        
                        // Apply FPS smoothing for better user experience
                        if (fpsElement) {
                            const smoothedFPS = smoothFPS(cameraId, status.fps);
                            fpsElement.textContent = smoothedFPS;
                        }
                        if (framesElement) framesElement.textContent = status.frames_captured.toLocaleString();
                        if (connectionElement) connectionElement.textContent = status.status;
                        
                        // Update recording indicators
                        const recordBtn = document.querySelector(`[data-camera-id="${cameraId}"] .record-toggle-btn`);
                        if (recordBtn) {
                            updateRecordingButton(recordBtn, status.recording.is_recording);
                        }
                        
                        // Update recording badge in header
                        const header = document.querySelector(`[data-camera-id="${cameraId}"] .card-header`);
                        const existingRecBadge = header.querySelector('.badge.bg-danger');
                        
                        if (status.recording.is_recording && !existingRecBadge) {
                            const recBadge = document.createElement('span');
                            recBadge.className = 'badge bg-danger';
                            recBadge.innerHTML = 'üî¥ REC';
                            header.querySelector('.d-flex').appendChild(recBadge);
                        } else if (!status.recording.is_recording && existingRecBadge) {
                            existingRecBadge.remove();
                        }
                    }
                }
                
                // Update last update time
                document.getElementById('lastUpdate').textContent = 'just now';
            }
        } catch (error) {
            console.error('Error updating real-time stats:', error);
        }
    }

    function showNotification(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
        alertDiv.style.zIndex = '9999';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(alertDiv);
        
        // Auto remove after 4 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 4000);
    }

    // Cleanup interval on page unload
    window.addEventListener('beforeunload', function() {
        if (updateInterval) {
            clearInterval(updateInterval);
        }
    });
});
</script>
{% endblock %}