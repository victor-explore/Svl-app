{% extends "base.html" %}

{% block title %}Camera Feed - Flask App{% endblock %}

{% block content %}
<!-- Camera Grid -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-5 pb-4" id="cameraGrid">
    {% for camera in cameras %}
    <div>
        <div class="card bg-base-100 shadow-xl" data-camera-id="{{ camera.id }}">
            <div class="card-header 
                {% if camera.status == 'online' %}bg-success
                {% elif camera.status == 'offline' %}bg-error
                {% else %}bg-warning
                {% endif %} text-white flex justify-between items-center">
                <h5 class="mb-0">{{ camera.name }}</h5>
                <span class="badge badge-neutral 
                    {% if camera.status == 'online' %}!text-success">üü¢ ONLINE
                    {% elif camera.status == 'offline' %}!text-error">üî¥ OFFLINE
                    {% else %}!text-warning">üü° CONNECTING
                    {% endif %}</span>
            </div>
            <div class="card-body p-0">
                <div class="position-relative" style="height: 200px; background: {% if camera.status == 'online' %}#000{% elif camera.status == 'offline' %}#333{% else %}#666{% endif %};">
                    {% if camera.status == 'online' %}
                        <img src="/api/cameras/{{ camera.id }}/stream" 
                             style="width: 100%; height: 200px; object-fit: cover;"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                             alt="Live stream from {{ camera.name }}">
                        <div class="hidden items-center justify-center h-full text-white absolute top-0 left-0 w-full">
                            <div class="text-center">
                                <div class="mb-2" style="font-size: 2rem;">üì∫</div>
                                <div>[STREAM ERROR]</div>
                                <div class="mt-2">‚ùå FAILED</div>
                            </div>
                        </div>
                    {% elif camera.status == 'offline' %}
                        <div class="flex items-center justify-center h-full text-white">
                            <div class="text-center">
                                <div class="mb-2" style="font-size: 2rem;">üì∫</div>
                                <div>[NO SIGNAL]</div>
                                <div class="mt-2">üî¥ OFFLINE</div>
                            </div>
                        </div>
                    {% else %}
                        <div class="flex items-center justify-center h-full text-white">
                            <div class="text-center">
                                <div class="mb-2">
                                    <div class="loading loading-spinner loading-lg" role="status">
                                        <span class="sr-only">Loading...</span>
                                    </div>
                                </div>
                                <div>[CONNECTING...]</div>
                                <div class="mt-2">üü° CONNECTING</div>
                            </div>
                        </div>
                    {% endif %}
                </div>
                <div class="p-3">
                </div>
            </div>
        </div>
    </div>
    {% endfor %}

    <!-- Add New Camera Card -->
    <div>
        <div class="card bg-base-100 shadow-xl border-2 border-dashed border-base-300">
            <div class="card-body text-center flex items-center justify-center" style="height: 300px;">
                <div>
                    <div class="mb-3" style="font-size: 3rem; color: #6c757d;">‚ûï</div>
                    <h5 class="text-muted mb-2">Add New Camera</h5>
                    <p class="text-muted small mb-3">Click to add a new RTSP camera feed</p>
                    <button class="btn btn-outline btn-primary" onclick="addCameraModal.showModal()">
                        Add Camera
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Stats Bottom Aligned -->
<div class="fixed bottom-0 left-0 w-full bg-base-200 border-t border-base-300 py-2" style="z-index: 1000;">
    <div class="text-center">
        <div class="mb-1">
            üìä <strong>Stats:</strong> 
            <span class="badge badge-success mr-1">{{ stats.online }} Online</span>
            <span class="badge badge-error mr-1">{{ stats.offline }} Offline</span>
            <span class="badge badge-warning mr-1">{{ stats.connecting }} Connecting</span>
        </div>
        <div class="text-base-content opacity-60">
            üïê <strong>Last Update:</strong> <span id="lastUpdate">1 min ago</span>
        </div>
    </div>
</div>

<!-- Add Camera Modal -->
<dialog id="addCameraModal" class="modal">
    <div class="modal-box w-11/12 max-w-5xl">
            <div class="flex justify-between items-center bg-success text-white p-4 -m-6 mb-4">
                <h1 class="text-lg font-bold">‚ûï Add New Camera</h1>
                <button type="button" class="btn btn-sm btn-circle btn-ghost text-white" onclick="addCameraModal.close()">‚úï</button>
            </div>
            <div>
                <form id="addCameraForm">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="mb-3">
                            <label for="cameraName" class="label">Camera Name <span class="text-error">*</span></label>
                            <input type="text" class="input input-bordered" id="cameraName" name="cameraName" placeholder="e.g., Front Door, Backyard" required>
                            <div class="text-sm text-base-content opacity-60 mt-1">Enter a descriptive name for your camera</div>
                        </div>
                        <div class="mb-3">
                            <label for="rtspUrl" class="label">RTSP URL <span class="text-error">*</span></label>
                            <input type="url" class="input input-bordered" id="rtspUrl" name="rtspUrl" placeholder="rtsp://192.168.1.100:554/stream" required>
                            <div class="text-sm text-base-content opacity-60 mt-1">Complete RTSP stream URL</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="mb-3">
                            <label for="username" class="label">Username</label>
                            <input type="text" class="input input-bordered" id="username" name="username" placeholder="admin">
                            <div class="text-sm text-base-content opacity-60 mt-1">Camera authentication username (optional)</div>
                        </div>
                        <div class="mb-3">
                            <label for="password" class="label">Password</label>
                            <input type="password" class="input input-bordered" id="password" name="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                            <div class="text-sm text-base-content opacity-60 mt-1">Camera authentication password (optional)</div>
                        </div>
                    </div>


                    <!-- Connection Test Status -->
                    <div id="connectionStatus" class="alert alert-info hidden" role="alert">
                        <div class="flex items-center">
                            <div class="loading loading-spinner loading-sm mr-2" role="status">
                                <span class="sr-only">Loading...</span>
                            </div>
                            Testing connection...
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-action justify-center">
                <button type="button" class="btn btn-outline btn-info" id="testConnection">
                    üîó Test Connection
                </button>
                <button type="button" class="btn" onclick="addCameraModal.close()">
                    Cancel
                </button>
                <button type="button" class="btn btn-success" id="addCameraBtn">
                    ‚ûï Add Camera
                </button>
            </div>
    </div>
</dialog>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const testConnectionBtn = document.getElementById('testConnection');
    const addCameraBtn = document.getElementById('addCameraBtn');
    const connectionStatus = document.getElementById('connectionStatus');
    const addCameraForm = document.getElementById('addCameraForm');
    const cameraGrid = document.getElementById('cameraGrid');

    // Test Connection functionality
    testConnectionBtn.addEventListener('click', function() {
        const rtspUrl = document.getElementById('rtspUrl').value.trim();
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value.trim();

        if (!rtspUrl) {
            alert('Please enter an RTSP URL first.');
            return;
        }

        // Show loading status
        connectionStatus.className = 'alert alert-info';
        connectionStatus.innerHTML = `
            <div class="flex items-center">
                <div class="loading loading-spinner loading-sm mr-2" role="status">
                    <span class="sr-only">Loading...</span>
                </div>
                Testing connection to ${rtspUrl}...
            </div>
        `;
        connectionStatus.classList.remove('hidden');

        // Simulate connection test (replace with actual RTSP test)
        setTimeout(() => {
            const isSuccess = Math.random() > 0.3; // 70% success rate for demo
            
            if (isSuccess) {
                connectionStatus.className = 'alert alert-success';
                connectionStatus.innerHTML = `
                    <div class="flex items-center">
                        <span class="mr-2">‚úÖ</span>
                        Connection successful! Camera stream is accessible.
                    </div>
                `;
            } else {
                connectionStatus.className = 'alert alert-error';
                connectionStatus.innerHTML = `
                    <div class="flex items-center">
                        <span class="mr-2">‚ùå</span>
                        Connection failed. Please check the RTSP URL and credentials.
                    </div>
                `;
            }
        }, 2000);
    });

    // Add Camera functionality
    addCameraBtn.addEventListener('click', function() {
        const formData = new FormData(addCameraForm);
        const cameraName = formData.get('cameraName').trim();
        const rtspUrl = formData.get('rtspUrl').trim();
        const username = formData.get('username').trim();
        const password = formData.get('password').trim();
        const autoStart = formData.get('autoStart') === 'on';
        const recordFootage = formData.get('recordFootage') === 'on';

        // Validate required fields
        if (!cameraName || !rtspUrl) {
            alert('Please fill in all required fields (Camera Name and RTSP URL).');
            return;
        }

        // Create new camera card
        const cameraId = Date.now(); // Simple ID generation
        const newCameraCard = createCameraCard(cameraId, cameraName, rtspUrl, autoStart);
        
        // Find the "Add New Camera" card and insert before it
        const addNewCard = cameraGrid.querySelector('.border-dashed').parentElement;
        cameraGrid.insertBefore(newCameraCard, addNewCard);

        // Clear form and close modal
        addCameraForm.reset();
        connectionStatus.classList.add('hidden');
        
        // Close modal
        document.getElementById('addCameraModal').close();

        // Update stats
        updateStats();
        
        // Show success message
        showNotification('Camera added successfully!', 'success');
    });

    function createCameraCard(id, name, rtspUrl, autoStart) {
        const col = document.createElement('div');
        col.className = '';
        
        const status = autoStart ? 'connecting' : 'offline';
        const statusInfo = getStatusInfo(status);
        
        col.innerHTML = `
            <div class="card bg-base-100 shadow-xl" data-camera-id="${id}">
                <div class="card-header ${statusInfo.headerClass} text-white flex justify-between items-center">
                    <h5 class="mb-0">${name}</h5>
                    <span class="badge badge-neutral ${statusInfo.badgeClass}">${statusInfo.statusText}</span>
                </div>
                <div class="card-body p-0">
                    <div class="relative" style="height: 200px; background: ${statusInfo.bgColor};">
                        <div class="flex items-center justify-center h-full text-white">
                            <div class="text-center">
                                ${statusInfo.content}
                            </div>
                        </div>
                    </div>
                    <div class="p-3">
                    </div>
                </div>
            </div>
        `;

        // If auto-start is enabled, simulate connection process
        if (autoStart) {
            setTimeout(() => {
                const card = col.querySelector('[data-camera-id="' + id + '"]');
                const success = Math.random() > 0.2; // 80% success rate
                updateCameraStatus(card, success ? 'online' : 'offline');
                updateStats();
            }, 3000 + Math.random() * 2000); // 3-5 second delay
        }

        return col;
    }

    function getStatusInfo(status) {
        switch(status) {
            case 'online':
                return {
                    headerClass: 'bg-success',
                    badgeClass: '!text-success',
                    statusText: 'üü¢ ONLINE',
                    bgColor: '#000',
                    content: `
                        <div class="mb-2" style="font-size: 2rem;">üì∫</div>
                        <div>[LIVE FEED]</div>
                        <div class="mt-2">üü¢ STREAMING</div>
                    `,
                    buttons: ''
                };
            case 'offline':
                return {
                    headerClass: 'bg-error',
                    badgeClass: '!text-error',
                    statusText: 'üî¥ OFFLINE',
                    bgColor: '#333',
                    content: `
                        <div class="mb-2" style="font-size: 2rem;">üì∫</div>
                        <div>[NO SIGNAL]</div>
                        <div class="mt-2">üî¥ OFFLINE</div>
                    `,
                    buttons: ''
                };
            case 'connecting':
                return {
                    headerClass: 'bg-warning',
                    badgeClass: '!text-warning',
                    statusText: 'üü° CONNECTING',
                    bgColor: '#666',
                    content: `
                        <div class="mb-2">
                            <div class="loading loading-spinner loading-lg" role="status">
                                <span class="sr-only">Loading...</span>
                            </div>
                        </div>
                        <div>[CONNECTING...]</div>
                        <div class="mt-2">üü° CONNECTING</div>
                    `,
                    buttons: ''
                };
        }
    }

    function updateCameraStatus(cardElement, newStatus) {
        const statusInfo = getStatusInfo(newStatus);
        const header = cardElement.querySelector('.card-header');
        const statusBadge = header.querySelector('.badge');
        const feedArea = cardElement.querySelector('.position-relative');
        const buttonsArea = cardElement.querySelector('.mt-2');

        // Update header class
        header.className = `card-header ${statusInfo.headerClass} text-white flex justify-between items-center`;
        
        // Update status badge
        statusBadge.className = `badge badge-neutral ${statusInfo.badgeClass}`;
        statusBadge.textContent = statusInfo.statusText;
        
        // Update feed area
        feedArea.style.background = statusInfo.bgColor;
        feedArea.querySelector('.text-center').innerHTML = statusInfo.content;
        
        // Update buttons
        buttonsArea.innerHTML = statusInfo.buttons;
    }

    function updateStats() {
        const cards = cameraGrid.querySelectorAll('.card[data-camera-id]');
        let onlineCount = 0;
        let offlineCount = 0;
        let connectingCount = 0;

        cards.forEach(card => {
            const statusBadge = card.querySelector('.badge');
            if (statusBadge.textContent.includes('ONLINE')) {
                onlineCount++;
            } else if (statusBadge.textContent.includes('OFFLINE')) {
                offlineCount++;
            } else if (statusBadge.textContent.includes('CONNECTING')) {
                connectingCount++;
            }
        });

        // Update bottom stats
        const bottomStats = document.querySelector('.fixed .text-center div:first-child');
        bottomStats.innerHTML = `
            üìä <strong>Stats:</strong> 
            <span class="badge badge-success mr-1">${onlineCount} Online</span>
            <span class="badge badge-error mr-1">${offlineCount} Offline</span>
            <span class="badge badge-warning mr-1">${connectingCount} Connecting</span>
        `;

        // Update last update time
        document.getElementById('lastUpdate').textContent = 'just now';
    }

    function showNotification(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} fixed top-0 left-1/2 transform -translate-x-1/2 mt-3`;
        alertDiv.style.zIndex = '9999';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn btn-sm btn-circle btn-ghost" onclick="this.parentElement.remove()">‚úï</button>
        `;
        
        document.body.appendChild(alertDiv);
        
        // Auto remove after 3 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 3000);
    }

    // Update last update time periodically
    setInterval(() => {
        const lastUpdateEl = document.getElementById('lastUpdate');
        const currentTime = Date.now();
        const timeDiff = Math.floor((currentTime - (lastUpdateEl.dataset.lastUpdate || currentTime)) / 1000);
        
        if (timeDiff < 60) {
            lastUpdateEl.textContent = `${timeDiff} sec ago`;
        } else if (timeDiff < 3600) {
            lastUpdateEl.textContent = `${Math.floor(timeDiff / 60)} min ago`;
        } else {
            lastUpdateEl.textContent = `${Math.floor(timeDiff / 3600)} hr ago`;
        }
    }, 1000);

    // Initialize last update timestamp
    document.getElementById('lastUpdate').dataset.lastUpdate = Date.now();
});
</script>
{% endblock %}