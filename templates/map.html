{% extends "base.html" %}

{% block title %}Map - Drishthi{% endblock %}

{% block content %}
<div class="container mx-auto py-6">
    <div class="mb-6">
        <div>
            <h1 class="text-3xl font-bold text-base-content mb-2">Surveillance Map</h1>
            <p class="text-base-content/70 mt-2">Real-time location view of all surveillance devices</p>
        </div>
    </div>


    <!-- Map Container -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body p-0">
            <div id="map" class="w-full h-[600px] md:h-[900px] rounded-lg"></div>
        </div>
    </div>

</div>

<!-- Map Setup Warning Modal -->
<dialog id="mapSetupModal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg">Map Setup Required</h3>
        <div class="py-4">
            <div class="alert alert-warning">
                <span>⚠️</span>
                <div>
                    <p>Offline map tiles are not available. To use the map feature:</p>
                    <ol class="list-decimal list-inside mt-2 space-y-1">
                        <li>Run the map setup script: <code class="bg-base-300 px-1 rounded">python scripts/setup_map.py</code></li>
                        <li>Enter your surveillance area coordinates</li>
                        <li>Wait for tiles to download</li>
                        <li>Refresh this page</li>
                    </ol>
                </div>
            </div>
        </div>
        <div class="modal-action">
            <button class="btn" onclick="document.getElementById('mapSetupModal').close()">Close</button>
        </div>
    </div>
</dialog>

<!-- Add CSS and JavaScript for Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
/* Ensure map container has explicit height for Leaflet */
#map { 
    height: 600px !important; 
}
@media (min-width: 768px) {
    #map { 
        height: 900px !important; 
    }
}
</style>

<!-- Map JavaScript -->
<script src="{{ url_for('static', filename='js/simple-map.js') }}"></script>

<script>
// Initialize map when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Initialize the surveillance map
    if (typeof SurveillanceMap !== 'undefined') {
        const mapConfig = {
            center: [{{ config.MAP_DEFAULT_CENTER_LAT }}, {{ config.MAP_DEFAULT_CENTER_LNG }}],
            zoom: {{ config.MAP_DEFAULT_ZOOM }},
            minZoom: {{ config.MAP_MIN_ZOOM }},
            maxZoom: {{ config.MAP_MAX_ZOOM }},
            tileUrlTemplate: 'https://tile.openstreetmap.org/{z}/{x}/{y}.png',
            markerColors: {{ config.CAMERA_MARKER_COLORS | tojson | safe }}
        };
        
        window.mapInstance = new SurveillanceMap('map', mapConfig);
        window.mapInstance.initialize();
        
    } else {
        console.error('SurveillanceMap class not loaded');
    }
});

</script>
{% endblock %}